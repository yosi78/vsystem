<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מאגר מידע למורות</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
			display: flex;
			flex-direction: column;
			min-height: 90vh;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '📚';
            font-size: 3rem;
            display: block;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* Footer Styles */
        .footer {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: auto;
            border-radius: 0 0 20px 20px;
        }
 .footer-name {
            font-size: 1.0em;
            font-weight: bold;
            color: #ecf0f1;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
        }
        
        .footer-name:hover {
            color: #3498db;
            transform: scale(1.05);
            text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        
        .footer-copyright {
            font-size: 0.8em;
            color: #bdc3c7;
            opacity: 0.8;
        }
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px 20px;
            min-height: 400px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .main-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .btn {
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .sub-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .sub-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            color: #333;
        }

        .sub-btn:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .sub-btn.nested {
            background: #e8f4fd;
            border-color: #007bff;
            margin-right: 20px;
            position: relative;
        }

        .sub-btn.nested::before {
            content: '└─';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            color: #007bff;
            font-weight: bold;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .breadcrumb {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .breadcrumb span {
            color: #007bff;
            font-weight: bold;
        }

        .resource-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .drive-link {
            display: inline-block;
            padding: 15px 30px;
            background: #4285f4;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-size: 1.1rem;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .drive-link:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }

        .comment-section {
            margin-top: 20px;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .name-input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
        }

        .comment-input {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            min-height: 80px;
            resize: vertical;
        }

        .send-btn {
            padding: 15px 25px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            align-self: flex-start;
        }

        .send-btn:hover {
            background: #218838;
        }

        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .comments-list {
            background: white;
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .comment {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .comment:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .comment-author {
            font-weight: bold;
            color: #333;
        }

        .comment-time {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .comment-text {
            color: #333;
            line-height: 1.4;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
        }

        .admin-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .admin-section {
            margin-bottom: 30px;
        }

        .admin-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .topic-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .topic-item.nested {
            margin-right: 20px;
            border-right: 3px solid #007bff;
            background: #f0f8ff;
        }

        /* סגנונות גרירה */
        .topic-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .topic-item.drag-over {
            border: 3px dashed #28a745;
            background: #d4edda;
            transform: scale(1.02);
        }

        .drop-zone {
            min-height: 40px;
            border: 2px dashed #28a745;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #28a745;
            margin-top: 10px;
            background: rgba(40, 167, 69, 0.1);
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            background: rgba(40, 167, 69, 0.2);
            border-color: #155724;
        }

        .drag-handle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: grab;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle:hover {
            background: #5a6268;
        }

        .topic-actions {
            display: flex;
            gap: 10px;
        }

        .edit-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .edit-btn:hover {
            background: #0056b3;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .add-nested-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .add-nested-btn:hover {
            background: #138496;
        }

        .add-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .add-input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }

        .add-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            align-self: flex-start;
        }

        .edit-form {
            background: #fff;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .edit-form h4 {
            color: #007bff;
            margin-bottom: 10px;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .save-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .firebase-setup {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .firebase-setup h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .firebase-setup p {
            color: #856404;
            margin-bottom: 10px;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 10px;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .level-selector {
            margin-bottom: 20px;
        }

        .level-selector select {
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-left: 10px;
            font-size: 1rem;
        }

        .drag-mode-toggle {
            background: #ffc107;
            color: #212529;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        .drag-mode-toggle:hover {
            background: #e0a800;
        }

        .drag-mode-toggle.active {
            background: #28a745;
            color: white;
        }

        .drag-instructions {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #0c5460;
            display: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .btn {
                font-size: 1.1rem;
                padding: 15px;
            }
            
            .sub-buttons {
                grid-template-columns: 1fr;
            }

            .comment-form {
                gap: 8px;
            }

            .add-form {
                flex-direction: column;
            }

            .topic-actions {
                flex-direction: column;
                gap: 5px;
            }

            .sub-btn.nested {
                margin-right: 10px;
            }

            .topic-item.nested {
                margin-right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>מאגר מידע למורות</h1>
            <p>version 0.4 <span id="connection-status" class="status-indicator status-disconnected">מנותק</span></p>
        </div>

        <div class="content">
            <!-- הודעת הגדרת Firebase -->
            <div class="firebase-setup" id="firebase-setup">
                <h3>🔧 הגדרת Firebase נדרשת</h3>
                <p>כדי שההערות יישמרו ויהיו זמינות לכל המורות, יש צורך בהגדרה קצרה של Firebase.</p>
                <p>עקבי אחרי ההוראות למטה כדי להפעיל את המערכת במלואה.</p>
            </div>

            <!-- מסך ראשי -->
            <div id="main-screen" class="screen active">
                <div class="main-buttons" id="main-buttons">
                    <!-- הכפתורים יתווספו כאן דינמית -->
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="showAdminLogin()" style="background: #6c757d; font-size: 1rem; padding: 10px 20px;">
                        ניהול
                    </button>
                </div>
            </div>

            <!-- מסך תתי נושאים -->
            <div id="sub-screen" class="screen">
                <button class="back-btn" onclick="navigateBack()">← חזרה</button>
                <div class="breadcrumb" id="breadcrumb"></div>
                <h2 id="sub-title"></h2>
                <div class="sub-buttons" id="sub-buttons">
                    <!-- תתי הנושאים יתווספו כאן -->
                </div>
            </div>

            <!-- מסך משאב -->
            <div id="resource-screen" class="screen">
                <button class="back-btn" onclick="navigateBack()">← חזרה</button>
                <div class="breadcrumb" id="resource-breadcrumb"></div>
                <h2 id="resource-title"></h2>
                
                <div class="resource-section">
                    <a href="#" id="drive-link" class="drive-link" target="_blank">
                        🔗 פתח קובץ בגוגל דרייב
                    </a>
					<div id="file-owner-display" style="margin-top: 10px; font-size: 1rem; color: #333;"></div>
                    
                    <div class="comment-section">
                        <h3>הערות וביקורת</h3>
                        
                        <div id="comment-error" class="error" style="display: none;"></div>
                        <div id="comment-success" class="success" style="display: none;"></div>
                        
                        <div class="comment-form">
                            <input type="text" class="name-input" id="user-name" placeholder="השם שלך (אופציונלי)">
                            <textarea class="comment-input" id="comment-input" placeholder="הכנסי הערה או ביקורת..."></textarea>
                            <button class="send-btn" id="send-btn" onclick="addComment()">שלח</button>
                        </div>
                        
                        <div class="comments-list" id="comments-list">
                            <div class="loading">טוען הערות...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- מסך כניסה למנהל -->
            <div id="login-screen" class="screen">
                <button class="back-btn" onclick="showMainScreen()">← חזרה</button>
                <div class="login-form">
                    <h2>כניסה למנהל</h2>
                    <input type="password" class="login-input" id="admin-password" placeholder="הכנס סיסמה">
                    <button class="btn" onclick="adminLogin()">כניסה</button>
                </div>
            </div>

            <!-- מסך מנהל -->
            <div id="admin-screen" class="screen">
                <button class="back-btn" onclick="showMainScreen()">← חזרה</button>
                <h2>פאנל מנהל</h2>
                
                <div class="admin-panel">
                    <!-- מצב גרירה -->
                    <button class="drag-mode-toggle" id="drag-mode-toggle" onclick="toggleDragMode()">
                        🔄 הפעל מצב גרירה
                    </button>
                    
                    <div class="drag-instructions" id="drag-instructions">
                        <strong>🎯 מצב גרירה פעיל!</strong><br>
                        • גרור נושאים באמצעות כפתור ה"⋮⋮"<br>
                        • שחרר על נושא אחר כדי להזיז תחתיו<br>
                        • שחרר על האזור הירוק כדי להזיז לרמה הראשונה<br>
                        • לחץ שוב על כפתור הגרירה כדי לצאת מהמצב
                    </div>
			
					<div class="admin-section">
                        <h3>🔐 שינוי סיסמת מנהל</h3>
                        <div class="password-change-section" style="background: #fff3cd; padding: 15px; border-radius: 10px; border: 1px solid #ffeaa7;">
                            <div id="password-change-error" class="error" style="display: none;"></div>
                            <div id="password-change-success" class="success" style="display: none;"></div>
                            
                            <div style="display: flex; flex-direction: column; gap: 10px; max-width: 400px;">
                                <input type="password" class="add-input" id="current-password" placeholder="סיסמה נוכחית" style="margin-bottom: 10px;">
                                <input type="password" class="add-input" id="new-password" placeholder="סיסמה חדשה" style="margin-bottom: 10px;">
                                <input type="password" class="add-input" id="confirm-password" placeholder="אימוד סיסמה חדשה" style="margin-bottom: 15px;">
                                <button class="btn" onclick="changeAdminPassword()" id="change-password-btn" style="background: #dc3545; font-size: 1rem; padding: 12px 20px; align-self: flex-start;">
                                    שנה סיסמה
                                </button>
                            </div>
                            
                            <div style="margin-top: 15px; font-size: 0.9em; color: #856404;">
                                <strong>הנחיות לסיסמה חזקה:</strong><br>
                                • לפחות 6 תווים<br>
                                • הימנע מסיסמאות פשוטות כמו "123456" או "password"<br>
                                • אל תשתף את הסיסמה עם אחרים
                            </div>
                        </div>
                    </div>
		
                    <div class="admin-section">
                        <h3>נושאים ראשיים</h3>
                        <div id="main-topics-list">
                            <!-- רשימת נושאים ראשיים -->
                        </div>
                        <div class="add-form">
                            <input type="text" class="add-input" id="new-main-topic" placeholder="נושא חדש">
                            <button class="add-btn" onclick="addMainTopic()">הוסף</button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>תתי נושאים</h3>
                        <div class="level-selector">
                            <label>בחר נושא ראשי:</label>
                            <select id="topic-select" class="add-input" style="margin-bottom: 10px;">
                                <option value="">בחר נושא ראשי</option>
                            </select>
                        </div>
                        
                        <div class="level-selector" id="parent-selector" style="display: none;">
                            <label>בחר תת נושא עליון (אופציונלי):</label>
                            <select id="parent-select" class="add-input">
                                <option value="">ללא נושא עליון (רמה ראשונה)</option>
                            </select>
                        </div>
                        
                        <div id="sub-topics-list">
                            <!-- רשימת תתי נושאים -->
                        </div>
                        <div class="add-form">
                            <input type="text" class="add-input" id="new-sub-topic" placeholder="תת נושא חדש">
                            <input type="text" class="add-input" id="new-drive-link" placeholder="קישור לגוגל דרייב (רק אם זה מסמך סופי)">
							<input type="text" class="add-input" id="new-file-owner" placeholder="שם בעל הקובץ (אופציונלי)">
                            <button class="add-btn" type="button" onclick="addSubTopic()">הוסף תת נושא</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
		<!-- Footer -->
		<div class="footer">
<a href="mailto:yosiel3@gmail.com?subject=בנוגע למערכת מאגר מידע&body=שלום יוסי," class="footer-name">ByteLogicx</a>
		<div class="footer-copyright">© 2023 כל הזכויות שמורות</div>
		</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
		apiKey: "AIzaSyC3IWkqDjwOLb4tTtgtfgkXdLSri8Voeag",
		authDomain: "data-storage-8c9ca.firebaseapp.com",
		databaseURL: "https://data-storage-8c9ca-default-rtdb.firebaseio.com",
		projectId: "data-storage-8c9ca",
		storageBucket: "data-storage-8c9ca.firebasestorage.app",
		messagingSenderId: "505046082965",
	    appId: "1:505046082965:web:e722ae19e5b5cbbfb2029c",
	    measurementId: "G-Q9HYH3ZWCJ"
	     };

        let database;
        let firebaseInitialized = false;

        // פונקציה לאתחול Firebase
        function initFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    console.log('Firebase SDK לא נטען');
                    return false;
                }

                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                firebaseInitialized = true;
                document.getElementById('firebase-setup').style.display = 'none';
                updateConnectionStatus(true);
                console.log('Firebase הוגדר בהצלחה');
                
                // טען נתונים מהבסיס
                loadDataFromFirebase();
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateConnectionStatus(false);
                return false;
            }
        }
		// פונקציה להצפנת סיסמה
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // פונקציה לשמירת סיסמה ראשונית
        async function setInitialAdminPassword() {
            if (!firebaseInitialized) {
                console.error('Firebase לא מחובר - לא ניתן לשמור סיסמה');
                return;
            }
            
            try {
                // בדוק אם כבר יש סיסמה
                const snapshot = await database.ref('adminPassword').once('value');
                if (snapshot.exists()) {
                    console.log('סיסמת מנהל כבר קיימת בבסיס הנתונים');
                    return;
                }
                
                // הצפן ושמור את הסיסמה הקיימת
                const hashedPassword = await hashPassword('n0987');
                await database.ref('adminPassword').set(hashedPassword);
                console.log('סיסמת מנהל נשמרה בבסיס הנתונים בהצפנה');
                
            } catch (error) {
                console.error('שגיאה בשמירת סיסמת מנהל:', error);
            }
        }
        // עדכון סטטוס חיבור
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (connected) {
                statusEl.textContent = 'מחובר';
                statusEl.className = 'status-indicator status-connected';
            } else {
                statusEl.textContent = 'לא מחובר';
                statusEl.className = 'status-indicator status-disconnected';
            }
        }

        // שמירת נתונים ב-Firebase
        async function saveDataToFirebase() {
            if (!firebaseInitialized) {
                console.log('Firebase לא מוגדר, שומר מקומית');
                saveDataLocally();
                return;
            }

            try {
                await database.ref('appData').set(appData);
                console.log('נתונים נשמרו בהצלחה ב-Firebase');
                showSuccess('השינויים נשמרו בהצלחה!');
            } catch (error) {
                console.error('שגיאה בשמירה ב-Firebase:', error);
                saveDataLocally(); // גיבוי מקומי
                showError('שגיאה בשמירה. הנתונים נשמרו מקומית.');
            }
        }

        // טעינת נתונים מ-Firebase
		function loadDataFromFirebase() {
			if (!firebaseInitialized) {
				loadDataLocally();
				return;
			}

			database.ref('appData').once('value')
				.then((snapshot) => {
					const data = snapshot.val();
					if (data) {
						appData = data;  // קודם עדכן את הנתונים
						updateExistingData(); // ואז הוסף שדות חסרים
						console.log('נתונים נטענו מ-Firebase');
					} else {
						saveDataToFirebase();
					}
					renderMainTopics();
					setInitialAdminPassword();
				})
				.catch((error) => {
					console.error('שגיאה בטעינה מ-Firebase:', error);
					loadDataLocally();
				});
		}

        // שמירה מקומית כגיבוי
        function saveDataLocally() {
            localStorage.setItem('teacherAppData', JSON.stringify(appData));
            console.log('נתונים נשמרו מקומית');
        }

        // טעינה מקומית
		function loadDataLocally() {
			const saved = localStorage.getItem('teacherAppData');
			if (saved) {
				try {
					const loadedData = JSON.parse(saved);
					appData = loadedData;
					updateExistingData(); // הוסף את השורה הזו
					console.log('נתונים נטענו מקומית');
				} catch (e) {
					console.error('שגיאה בטעינת נתונים מקומיים:', e);
				}
			}
			renderMainTopics();
		}

        // פונקציה להוספת הערה
        window.addCommentToFirebase = async function(resourceId, commentText, userName) {
            if (!firebaseInitialized) {
                throw new Error('Firebase לא מוגדר');
            }

            const commentsRef = database.ref(`comments/${resourceId}`);
            await commentsRef.push({
                text: commentText,
                author: userName || 'אנונימי',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        };

        // פונקציה לטעינת הערות
        window.loadCommentsFromFirebase = function(resourceId, callback) {
            if (!firebaseInitialized) {
                console.log('Firebase לא מוגדר, משתמש בנתונים מקומיים');
                callback([]);
                return;
            }

            const commentsRef = database.ref(`comments/${resourceId}`);
            commentsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const comments = [];
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        comments.push({
                            id: key,
                            ...data[key]
                        });
                    });
                }
                
                comments.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                callback(comments);
            });
        };

        // אתחול Firebase כשהעמוד נטען
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                    initFirebase();
                } else {
                    loadDataLocally();
                }
            }, 100);
        });
    </script>

    <script>
        // נתונים ראשיים - עם תמיכה בתתי נושאים מקוננים
        let appData = {
            mainTopics: [
                {
                    id: 1,
                    name: "ימי חוץ",
                    subTopics: [
                        { 
                            id: 1, 
                            name: "תכנון שנתי", 
                            driveLink: "",
							fileOwner: "",
                            subTopics: []
                        },
                        { 
                            id: 2, 
                            name: "חונכות", 
                            driveLink: "", 
							fileOwner: "",
                            subTopics: [
                                { id: 10, name: "תכנון לחודש ספטמבר", driveLink: "", fileOwner: "", subTopics: [] },
                                { id: 11, name: "תכנון לחודש אוקטובר", driveLink: "", fileOwner: "", subTopics: [] }
                            ]
                        },
                        { 
                            id: 3, 
                            name: "מדריכים", 
                            driveLink: "",
							fileOwner: "",
                            subTopics: []
                        }
                    ]
                },
                {
                    id: 2,
                    name: "משולשים",
                    subTopics: [
                        { 
                            id: 4, 
                            name: "מבחנים", 
                            driveLink: "",
							fileOwner: "",
                            subTopics: [
                                { id: 12, name: "מבחני מתמטיקה", driveLink: "", fileOwner: "", subTopics: [] },
                                { id: 13, name: "מבחני עברית", driveLink: "", fileOwner: "", subTopics: [] }
                            ]
                        },
                        { 
                            id: 5, 
                            name: "משימות", 
                            driveLink: "",
							fileOwner: "",
                            subTopics: []
                        },
                        { 
                            id: 6, 
                            name: "פרויקטים", 
                            driveLink: "",
							fileOwner: "",
                            subTopics: []
                        }
                    ]
                },
                {
                    id: 3,
                    name: "מדריכים",
                    subTopics: [
                        { 
                            id: 7, 
                            name: "משמעת", 
                            driveLink: "",
							fileOwner: "",
                            subTopics: []
                        },
                        { 
                            id: 8, 
                            name: "מוטיבציה", 
                            driveLink: "",
							fileOwner: "",
                            subTopics: []
                        },
                        { 
                            id: 9, 
                            name: "תקשורת", 
                            driveLink: "",
							fileOwner: "",
                            subTopics: []
                        }
                    ]
                }
            ]
        };

        let currentMainTopic = null;
        let currentSubTopic = null;
        let currentPath = [];
        let editingMainTopic = null;
        let editingSubTopic = null;
        
        // משתני גרירה
        let isDragMode = false;
        let draggedElement = null;
        let draggedData = null;

        // אתחול האתר
        function initApp() {
			updateExistingData();
            renderMainTopics();
        }

		// פונקציה להוספת שדה fileOwner לנתונים קיימים
		function updateExistingData() {
			function addFileOwnerField(subTopics) {
				subTopics.forEach(subTopic => {
					if (!subTopic.hasOwnProperty('fileOwner')) {
						subTopic.fileOwner = '';
					}
					if (subTopic.subTopics && subTopic.subTopics.length > 0) {
						addFileOwnerField(subTopic.subTopics);
					}
				});
			}
			
			appData.mainTopics.forEach(mainTopic => {
				if (mainTopic.subTopics) {
					addFileOwnerField(mainTopic.subTopics);
				}
			});
		}

        // הצגת הנושאים הראשיים
        function renderMainTopics() {
            const container = document.getElementById('main-buttons');
            container.innerHTML = '';
            
            appData.mainTopics.forEach(topic => {
                const button = document.createElement('button');
                button.className = 'btn';
                button.textContent = topic.name;
                button.onclick = () => showSubTopics(topic);
                container.appendChild(button);
            });
        }

        // הצגת תתי נושאים - עם תמיכה בנתיב
        function showSubTopics(topic, parentPath = []) {
            currentMainTopic = topic;
            currentPath = [...parentPath, topic];
            
            // עדכון כותרת
            document.getElementById('sub-title').textContent = topic.name;
            
            // עדכון breadcrumb
            updateBreadcrumb();
            
            const container = document.getElementById('sub-buttons');
            container.innerHTML = '';
            
            if (topic.subTopics && topic.subTopics.length > 0) {
                topic.subTopics.forEach(subTopic => {
                    const button = document.createElement('button');
                    
                    // בדיקה אם זה מסמך סופי או יש עוד תתי נושאים
                    if (subTopic.subTopics && subTopic.subTopics.length > 0) {
                        // יש עוד תתי נושאים - כפתור לנווט הלאה
                        button.className = 'sub-btn';
                        button.textContent = subTopic.name + ' ►';
                        button.onclick = () => showSubTopics(subTopic, currentPath);
                    } else if (subTopic.driveLink && subTopic.driveLink.trim()) {
                        // מסמך סופי - כפתור לפתיחת המשאב
                        button.className = 'sub-btn';
                        button.textContent = subTopic.name;
                        button.onclick = () => showResource(subTopic);
                    } else {
                        // אין קישור ואין תתי נושאים - תת נושא ריק
                        button.className = 'sub-btn';
                        button.textContent = subTopic.name + ' (ריק)';
                        button.style.opacity = '0.6';
                        button.onclick = () => showSubTopics(subTopic, currentPath);
                    }
                    
                    container.appendChild(button);
                });
            } else {
                // אין תתי נושאים
                const emptyDiv = document.createElement('div');
                emptyDiv.style.textAlign = 'center';
                emptyDiv.style.color = '#6c757d';
                emptyDiv.style.padding = '20px';
                emptyDiv.textContent = 'אין תתי נושאים עדיין';
                container.appendChild(emptyDiv);
            }
            
            showScreen('sub-screen');
        }

        // עדכון breadcrumb
        function updateBreadcrumb() {
            const breadcrumbEl = document.getElementById('breadcrumb');
            if (currentPath.length <= 1) {
                breadcrumbEl.style.display = 'none';
                return;
            }
            
            breadcrumbEl.style.display = 'block';
            const pathText = currentPath.map(item => item.name).join(' ← ');
            breadcrumbEl.innerHTML = 'מיקום: <span>' + pathText + '</span>';
        }

        // ניווט חזרה חכם
        function navigateBack() {
            if (currentPath.length > 1) {
                // חזרה לרמה הקודמת
                currentPath.pop();
                const parentTopic = currentPath[currentPath.length - 1];
                showSubTopics(parentTopic, currentPath.slice(0, -1));
            } else {
                // חזרה למסך הראשי
                showMainScreen();
            }
        }

        // הצגת משאב
        function showResource(subTopic) {
            currentSubTopic = subTopic;
            document.getElementById('resource-title').textContent = subTopic.name;
            document.getElementById('drive-link').href = subTopic.driveLink;
            
			const fileOwnerDisplay = document.getElementById('file-owner-display');
			if (subTopic.fileOwner && subTopic.fileOwner.trim()) {
				fileOwnerDisplay.innerHTML = '👤 <strong>בעל הקובץ:</strong> ' + subTopic.fileOwner;
				fileOwnerDisplay.style.display = 'block';
			} else {
				fileOwnerDisplay.style.display = 'none';
			}

            // עדכון breadcrumb למשאב
            const resourceBreadcrumb = document.getElementById('resource-breadcrumb');
            const fullPath = [...currentPath, subTopic];
            const pathText = fullPath.map(item => item.name).join(' ← ');
            resourceBreadcrumb.innerHTML = 'מיקום: <span>' + pathText + '</span>';
            
            loadResourceComments(subTopic.id);
            showScreen('resource-screen');
        }

        // הוספת הערה
        async function addComment() {
            const commentInput = document.getElementById('comment-input');
            const nameInput = document.getElementById('user-name');
            const sendBtn = document.getElementById('send-btn');
            const errorDiv = document.getElementById('comment-error');
            const successDiv = document.getElementById('comment-success');
            
            const commentText = commentInput.value.trim();
            const userName = nameInput.value.trim();
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            if (!commentText) {
                showError('אנא הכנסי הערה');
                return;
            }
            
            if (!currentSubTopic) {
                showError('שגיאה: לא נבחר נושא');
                return;
            }
            
            sendBtn.disabled = true;
            sendBtn.textContent = 'שולח...';
            
            try {
                if (firebaseInitialized && window.addCommentToFirebase) {
                    await window.addCommentToFirebase(currentSubTopic.id, commentText, userName);
                    commentInput.value = '';
                    nameInput.value = '';
                    showSuccess('ההערה נשלחה בהצלחה!');
                } else {
                    addCommentLocally(currentSubTopic.id, commentText, userName);
                    commentInput.value = '';
                    nameInput.value = '';
                    showSuccess('ההערה נשמרה מקומית (Firebase לא מוגדר)');
                }
            } catch (error) {
                console.error('Error adding comment:', error);
                showError('שגיאה בשליחת ההערה. אנא נסי שוב.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'שלח';
            }
        }

        // שמירה מקומית כגיבוי
        let localComments = {};

        function addCommentLocally(resourceId, commentText, userName) {
            if (!localComments[resourceId]) {
                localComments[resourceId] = [];
            }
            
            localComments[resourceId].unshift({
                text: commentText,
                author: userName || 'אנונימי',
                timestamp: Date.now()
            });
            
            localStorage.setItem('teacherComments', JSON.stringify(localComments));
            loadResourceComments(resourceId);
        }

        function loadLocalComments() {
            const saved = localStorage.getItem('teacherComments');
            if (saved) {
                try {
                    localComments = JSON.parse(saved);
                } catch (e) {
                    localComments = {};
                }
            }
        }

        // טעינת הערות למשאב
        function loadResourceComments(resourceId) {
            const container = document.getElementById('comments-list');
            container.innerHTML = '<div class="loading">טוען הערות...</div>';
            
            if (window.loadCommentsFromFirebase) {
                window.loadCommentsFromFirebase(resourceId, (comments) => {
                    displayComments(comments);
                });
            } else {
                setTimeout(() => {
                    container.innerHTML = '<p style="text-align: center; color: #6c757d;">מערכת ההערות לא מוגדרת</p>';
                }, 1000);
            }
        }

        // הצגת הערות
        function displayComments(comments) {
            const container = document.getElementById('comments-list');
            container.innerHTML = '';
            
            if (comments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">אין הערות עדיין</p>';
                return;
            }
            
            comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                
                const timestamp = comment.timestamp ? 
                    new Date(comment.timestamp).toLocaleString('he-IL') : 
                    'זמן לא ידוע';
                
                commentDiv.innerHTML = `
                    <div class="comment-header">
                        <span class="comment-author">${comment.author || 'אנונימי'}</span>
                        <span class="comment-time">${timestamp}</span>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                `;
                container.appendChild(commentDiv);
            });
        }

        // הצגת הודעת שגיאה
        function showError(message) {
            const errorDiv = document.getElementById('comment-error');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            } else {
                alert(message);
            }
        }

        // הצגת הודעת הצלחה
        function showSuccess(message) {
            const successDiv = document.getElementById('comment-success');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            } else {
                console.log('הצלחה: ' + message);
            }
        }

        // מעבר בין מסכים
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showMainScreen() {
            currentPath = [];
            showScreen('main-screen');
        }

        function showSubScreen() {
            showScreen('sub-screen');
        }

        function showAdminLogin() {
            showScreen('login-screen');
        }

        // כניסת מנהל
        async function adminLogin() {
    const password = document.getElementById('admin-password').value;
    const loginBtn = document.querySelector('#login-screen .btn');
    
    if (!password.trim()) {
        alert('אנא הכנס סיסמה');
        return;
    }
    
    loginBtn.disabled = true;
    loginBtn.textContent = 'בודק...';
    
    try {
        if (!firebaseInitialized) {
            alert('שגיאה: מערכת לא מחוברת לבסיס הנתונים');
            return;
        }
        
        // קבל את הסיסמה המוצפנת מהבסיס
        const snapshot = await database.ref('adminPassword').once('value');
        if (!snapshot.exists()) {
            alert('שגיאה: לא נמצאה סיסמת מנהל');
            return;
        }
        
        const storedHash = snapshot.val();
        const enteredHash = await hashPassword(password);
        
        if (storedHash === enteredHash) {
            document.getElementById('admin-password').value = '';
            showAdminPanel();
        } else {
            alert('סיסמה שגויה');
        }
        
    } catch (error) {
        console.error('שגיאה בבדיקת סיסמה:', error);
        alert('שגיאה בבדיקת סיסמה');
    } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'כניסה';
    }
}

        function showAdminPanel() {
            renderAdminPanel();
            showScreen('admin-screen');
        }

        // פונקציות גרירה
        function toggleDragMode() {
            isDragMode = !isDragMode;
            const toggleBtn = document.getElementById('drag-mode-toggle');
            const instructions = document.getElementById('drag-instructions');
            
            if (isDragMode) {
                toggleBtn.classList.add('active');
                toggleBtn.innerHTML = '🔒 צא ממצב גרירה';
                instructions.style.display = 'block';
            } else {
                toggleBtn.classList.remove('active');
                toggleBtn.innerHTML = '🔄 הפעל מצב גרירה';
                instructions.style.display = 'none';
            }
            
            renderSubTopics(); // רענן את הרשימה עם/בלי כפתורי גרירה
        }

        function setupDropZone(element, targetData) {
            element.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (draggedElement && draggedElement !== element) {
                    element.classList.add('drag-over');
                }
            });
            
            element.addEventListener('dragleave', (e) => {
                element.classList.remove('drag-over');
            });
            
            element.addEventListener('drop', (e) => {
                e.preventDefault();
                element.classList.remove('drag-over');
                
                if (!draggedData) return;
                
                const { subTopicId: draggedId, mainTopicId: draggedMainId } = draggedData;
                const { subTopicId: targetId, mainTopicId: targetMainId, isNested } = targetData;
                
                if (draggedId === targetId) return; // לא ניתן להזיז לעצמו
                
                moveSubTopic(draggedId, draggedMainId, targetId, targetMainId, isNested);
            });
        }

        function moveSubTopic(draggedId, draggedMainId, targetId, targetMainId, isNested) {
            // מצא ומסיר את הנושא הנגרר
            const draggedTopic = removeSubTopicById(draggedMainId, draggedId);
            if (!draggedTopic) {
                showError('שגיאה: לא ניתן למצוא את הנושא הנגרר');
                return;
            }
            
            // הוסף לייעד החדש
            if (targetId && targetMainId) {
                // הזחה תחת נושא קיים
                if (isNested) {
                    addSubTopicUnder(targetMainId, targetId, draggedTopic);
                } else {
                    addSubTopicAfter(targetMainId, targetId, draggedTopic);
                }
            } else {
                // הזחה לרמה הראשונה של נושא ראשי
                const mainTopic = appData.mainTopics.find(t => t.id === targetMainId);
                if (mainTopic) {
                    mainTopic.subTopics.push(draggedTopic);
                }
            }
            
            saveDataToFirebase();
            renderParentSelect();
            renderSubTopics();
            showSuccess('הנושא הועבר בהצלחה!');
        }

        function removeSubTopicById(mainTopicId, subTopicId) {
            const mainTopic = appData.mainTopics.find(t => t.id === mainTopicId);
            if (!mainTopic) return null;
            
            function removeRecursively(subTopics) {
                for (let i = 0; i < subTopics.length; i++) {
                    if (subTopics[i].id === subTopicId) {
                        return subTopics.splice(i, 1)[0];
                    }
                    if (subTopics[i].subTopics) {
                        const found = removeRecursively(subTopics[i].subTopics);
                        if (found) return found;
                    }
                }
                return null;
            }
            
            return removeRecursively(mainTopic.subTopics);
        }

        function addSubTopicUnder(mainTopicId, parentId, newSubTopic) {
            const mainTopic = appData.mainTopics.find(t => t.id === mainTopicId);
            if (!mainTopic) return;
            
            const parentSubTopic = findSubTopicById(mainTopic.subTopics, parentId);
            if (parentSubTopic) {
                if (!parentSubTopic.subTopics) {
                    parentSubTopic.subTopics = [];
                }
                parentSubTopic.subTopics.push(newSubTopic);
            }
        }

        // עמוד מנהל
        function renderAdminPanel() {
            renderMainTopicsAdmin();
            renderTopicSelect();
            renderSubTopics();
        }

        function renderMainTopicsAdmin() {
            const mainTopicsList = document.getElementById('main-topics-list');
            mainTopicsList.innerHTML = '';
            
            appData.mainTopics.forEach(topic => {
                if (editingMainTopic && editingMainTopic.id === topic.id) {
                    const editDiv = document.createElement('div');
                    editDiv.className = 'edit-form';
                    editDiv.innerHTML = `
                        <h4>עריכת נושא ראשי</h4>
                        <input type="text" class="add-input" id="edit-main-topic-${topic.id}" value="${topic.name}">
                        <div class="edit-actions">
                            <button class="save-btn" onclick="saveMainTopic(${topic.id})">שמור</button>
                            <button class="cancel-btn" onclick="cancelEditMainTopic()">ביטול</button>
                        </div>
                    `;
                    mainTopicsList.appendChild(editDiv);
                } else {
                    const topicDiv = document.createElement('div');
                    topicDiv.className = 'topic-item';
                    topicDiv.innerHTML = `
                        <span>${topic.name}</span>
                        <div class="topic-actions">
                            <button class="edit-btn" onclick="editMainTopic(${topic.id})">ערוך</button>
                            <button class="delete-btn" onclick="deleteMainTopic(${topic.id})">מחק</button>
                        </div>
                    `;
                    mainTopicsList.appendChild(topicDiv);
                }
            });
        }

        function renderTopicSelect() {
            const topicSelect = document.getElementById('topic-select');
            topicSelect.innerHTML = '<option value="">בחר נושא ראשי</option>';
            
            appData.mainTopics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.id;
                option.textContent = topic.name;
                topicSelect.appendChild(option);
            });

            topicSelect.onchange = () => {
                renderParentSelect();
                renderSubTopics();
            };
        }

        // רנדור בחירת נושא עליון
        function renderParentSelect() {
            const topicSelect = document.getElementById('topic-select');
            const parentSelect = document.getElementById('parent-select');
            const parentSelector = document.getElementById('parent-selector');
            
            const selectedTopicId = topicSelect.value;
            
            if (!selectedTopicId) {
                parentSelector.style.display = 'none';
                return;
            }
            
            parentSelector.style.display = 'block';
            parentSelect.innerHTML = '<option value="">ללא נושא עליון (רמה ראשונה)</option>';
            
            const topic = appData.mainTopics.find(t => t.id == selectedTopicId);
            if (topic && topic.subTopics) {
                populateParentOptions(topic.subTopics, parentSelect, '');
            }
            
            parentSelect.onchange = renderSubTopics;
        }

        // פונקציה רקורסיבית למילוי אופציות נושא עליון
        function populateParentOptions(subTopics, selectElement, prefix) {
            subTopics.forEach(subTopic => {
                const option = document.createElement('option');
                option.value = subTopic.id;
                option.textContent = prefix + subTopic.name;
                selectElement.appendChild(option);
                
                if (subTopic.subTopics && subTopic.subTopics.length > 0) {
                    populateParentOptions(subTopic.subTopics, selectElement, prefix + '  └─ ');
                }
            });
        }

        // פונקציה למציאת תת נושא לפי ID
        function findSubTopicById(subTopics, id) {
            for (let subTopic of subTopics) {
                if (subTopic.id == id) {
                    return subTopic;
                }
                if (subTopic.subTopics) {
                    const found = findSubTopicById(subTopic.subTopics, id);
                    if (found) return found;
                }
            }
            return null;
        }

        // פונקציה למציאת תת נושא והורה שלו
        function findSubTopicWithParent(subTopics, id, parent = null) {
            for (let subTopic of subTopics) {
                if (subTopic.id == id) {
                    return { subTopic, parent };
                }
                if (subTopic.subTopics) {
                    const found = findSubTopicWithParent(subTopic.subTopics, id, subTopic);
                    if (found) return found;
                }
            }
            return null;
        }

        function renderSubTopics() {
            const topicSelect = document.getElementById('topic-select');
            const parentSelect = document.getElementById('parent-select');
            const subTopicsList = document.getElementById('sub-topics-list');
            subTopicsList.innerHTML = '';
            
            const selectedTopicId = topicSelect.value;
            if (!selectedTopicId) return;
            
            const topic = appData.mainTopics.find(t => t.id == selectedTopicId);
            if (!topic) return;
            
            const parentId = parentSelect.value;
            let targetSubTopics;
            
            if (parentId) {
                const parentSubTopic = findSubTopicById(topic.subTopics, parentId);
                targetSubTopics = parentSubTopic ? parentSubTopic.subTopics : [];
            } else {
                targetSubTopics = topic.subTopics;
            }
            
            if (targetSubTopics) {
                renderSubTopicsList(targetSubTopics, subTopicsList, topic.id, 0);
            }
            
            // הוסף אזור הטלה כללי במצב גרירה
            if (isDragMode && targetSubTopics.length > 0) {
                const dropZone = document.createElement('div');
                dropZone.className = 'drop-zone';
                dropZone.textContent = 'שחרר כאן כדי להוסיף לרמה הראשונה';
                
                setupDropZone(dropZone, { 
                    subTopicId: null, 
                    mainTopicId: parseInt(selectedTopicId), 
                    isNested: false 
                });
                
                subTopicsList.appendChild(dropZone);
            }
        }

        function renderSubTopicsList(subTopics, container, mainTopicId, level = 0) {
            subTopics.forEach(subTopic => {
                if (editingSubTopic && editingSubTopic.id === subTopic.id) {
                    const editDiv = document.createElement('div');
                    editDiv.className = 'edit-form';
                    if (level > 0) editDiv.className += ' nested';
                    editDiv.innerHTML = `
                        <h4>עריכת תת נושא</h4>
                        <input type="text" class="add-input" id="edit-sub-topic-name-${subTopic.id}" value="${subTopic.name}" placeholder="שם תת נושא">
                        <input type="text" class="add-input" id="edit-sub-topic-link-${subTopic.id}" value="${subTopic.driveLink || ''}" placeholder="קישור גוגל דרייב (אופציונלי)">
						<input type="text" class="add-input" id="edit-sub-topic-owner-${subTopic.id}" value="${subTopic.fileOwner || ''}" placeholder="שם בעל הקובץ (אופציונלי)">
                        <div class="edit-actions">
                            <button class="save-btn" onclick="saveSubTopic(${mainTopicId}, ${subTopic.id})">שמור</button>
                            <button class="cancel-btn" onclick="cancelEditSubTopic()">ביטול</button>
                        </div>
                    `;
                    container.appendChild(editDiv);
                } else {
                    const subTopicDiv = document.createElement('div');
                    subTopicDiv.className = 'topic-item';
                    if (level > 0) subTopicDiv.className += ' nested';
                    
                    const hasSubTopics = subTopic.subTopics && subTopic.subTopics.length > 0;
                    const hasLink = subTopic.driveLink && subTopic.driveLink.trim();
                    
                    let statusText = '';
                    if (hasSubTopics && hasLink) {
                        statusText = ' <span style="color: #28a745;">(קטגוריה + מסמך)</span>';
                    } else if (hasSubTopics) {
                        statusText = ' <span style="color: #007bff;">(קטגוריה)</span>';
                    } else if (hasLink) {
                        statusText = ' <span style="color: #17a2b8;">(מסמך)</span>';
                    } else {
                        statusText = ' <span style="color: #6c757d;">(ריק)</span>';
                    }
                    
                    subTopicDiv.innerHTML = `
                        <div>
                            <strong>${subTopic.name}</strong>${statusText}
                            ${hasLink ? '<br><small style="color: #007bff;">🔗 ' + subTopic.driveLink + '</small>' + (subTopic.fileOwner ? '<br><small style="color: #28a745;">👤 ' + subTopic.fileOwner + '</small>' : '') : ''}
                            ${hasSubTopics ? '<br><small style="color: #28a745;">📁 ' + subTopic.subTopics.length + ' תתי נושאים</small>' : ''}
                        </div>
                        <div class="topic-actions">
                            <button class="add-nested-btn" onclick="addNestedSubTopic(${subTopic.id})" title="הוסף תת נושא תחת ${subTopic.name}">הוסף תחת</button>
                            <button class="edit-btn" onclick="editSubTopic(${subTopic.id})" title="ערוך ${subTopic.name}">ערוך</button>
                            <button class="delete-btn" onclick="deleteSubTopic(${mainTopicId}, ${subTopic.id})" title="מחק ${subTopic.name}">מחק</button>
                        </div>
                    `;
                    container.appendChild(subTopicDiv);
                    
                    // הוסף כפתור גרירה במצב גרירה
                    if (isDragMode) {
                        const dragHandle = document.createElement('button');
                        dragHandle.className = 'drag-handle';
                        dragHandle.innerHTML = '⋮⋮';
                        dragHandle.title = 'גרור לשינוי מיקום';
                        dragHandle.draggable = true;
                        
                        // הוסף את כפתור הגרירה לתחילת הפעולות
                        const actionsDiv = subTopicDiv.querySelector('.topic-actions');
                        actionsDiv.insertBefore(dragHandle, actionsDiv.firstChild);
                        
                        // הגדר אירועי גרירה
                        dragHandle.addEventListener('dragstart', (e) => {
                            draggedData = { subTopicId: subTopic.id, mainTopicId: mainTopicId };
                            draggedElement = subTopicDiv;
                            draggedElement.classList.add('dragging');
                            e.dataTransfer.setData('text/plain', '');
                        });
                        
                        dragHandle.addEventListener('dragend', (e) => {
                            if (draggedElement) {
                                draggedElement.classList.remove('dragging');
                            }
                            document.querySelectorAll('.topic-item, .drop-zone').forEach(item => {
                                item.classList.remove('drag-over');
                            });
                            draggedElement = null;
                            draggedData = null;
                        });
                        
                        // הגדר אזור הטלה
                        setupDropZone(subTopicDiv, { 
                            subTopicId: subTopic.id, 
                            mainTopicId: mainTopicId, 
                            isNested: true 
                        });
                    }
                    
                    // רנדור תתי נושאים מקוננים
                    if (hasSubTopics) {
                        renderSubTopicsList(subTopic.subTopics, container, mainTopicId, level + 1);
                    }
                }
            });
        }

        // פונקציות עריכה לנושאים ראשיים
        function editMainTopic(topicId) {
            const topic = appData.mainTopics.find(t => t.id === topicId);
            editingMainTopic = topic;
            renderMainTopicsAdmin();
        }

        function saveMainTopic(topicId) {
            const newName = document.getElementById(`edit-main-topic-${topicId}`).value.trim();
            if (newName) {
                const topic = appData.mainTopics.find(t => t.id === topicId);
                topic.name = newName;
                editingMainTopic = null;
                saveDataToFirebase();
                renderMainTopics();
                renderAdminPanel();
            }
        }

        function cancelEditMainTopic() {
            editingMainTopic = null;
            renderMainTopicsAdmin();
        }

        // פונקציות עריכה לתתי נושאים
        function editSubTopic(subTopicId) {
            const topicSelect = document.getElementById('topic-select');
            const selectedTopicId = topicSelect.value;
            const topic = appData.mainTopics.find(t => t.id == selectedTopicId);
            
            if (topic) {
                const subTopic = findSubTopicById(topic.subTopics, subTopicId);
                editingSubTopic = subTopic;
                renderSubTopics();
            }
        }

        function saveSubTopic(topicId, subTopicId) {
            const newName = document.getElementById(`edit-sub-topic-name-${subTopicId}`).value.trim();
            const newLink = document.getElementById(`edit-sub-topic-link-${subTopicId}`).value.trim();
			const newOwner = document.getElementById(`edit-sub-topic-owner-${subTopicId}`).value.trim();
            
            if (newName) {
                const topic = appData.mainTopics.find(t => t.id === topicId);
                const subTopic = findSubTopicById(topic.subTopics, subTopicId);
                
                if (subTopic) {
                    subTopic.name = newName;
                    subTopic.driveLink = newLink;
					subTopic.fileOwner = newOwner;
                    editingSubTopic = null;
                    
                    saveDataToFirebase();
                    renderParentSelect();
                    renderSubTopics();
                    showSuccess('תת הנושא עודכן בהצלחה!');
                }
            } else {
                showError('שם תת הנושא לא יכול להיות ריק');
            }
        }

        function cancelEditSubTopic() {
            editingSubTopic = null;
            renderSubTopics();
        }

        // הוספת נושא ראשי
        function addMainTopic() {
            const input = document.getElementById('new-main-topic');
            const name = input.value.trim();
            
            if (name) {
                const newId = Math.max(...appData.mainTopics.map(t => t.id), 0) + 1;
                appData.mainTopics.push({
                    id: newId,
                    name: name,
                    subTopics: []
                });
                
                input.value = '';
                saveDataToFirebase();
                renderMainTopics();
                renderAdminPanel();
                alert('נושא ראשי נוסף בהצלחה!');
            } else {
                alert('אנא הכנס שם לנושא');
            }
        }

        // פונקציה למציאת הID הגבוה ביותר
        function getMaxSubTopicId() {
            let maxId = 0;
            
            function searchInSubTopics(subTopics) {
                subTopics.forEach(subTopic => {
                    if (subTopic.id > maxId) {
                        maxId = subTopic.id;
                    }
                    if (subTopic.subTopics) {
                        searchInSubTopics(subTopic.subTopics);
                    }
                });
            }
            
            appData.mainTopics.forEach(topic => {
                if (topic.subTopics) {
                    searchInSubTopics(topic.subTopics);
                }
            });
            
            return maxId;
        }

        // הוספת תת נושא
        function addSubTopic() {
            try {
                const topicSelect = document.getElementById('topic-select');
                const parentSelect = document.getElementById('parent-select');
                const nameInput = document.getElementById('new-sub-topic');
                const linkInput = document.getElementById('new-drive-link');
				const ownerInput = document.getElementById('new-file-owner');
                
                const topicId = parseInt(topicSelect.value);
                const parentId = parentSelect.value ? parseInt(parentSelect.value) : null;
                const name = nameInput.value.trim();
                const driveLink = linkInput.value.trim();
				const fileOwner = ownerInput.value.trim();
                
                if (!topicId || isNaN(topicId)) {
                    alert('אנא בחר נושא ראשי');
                    return;
                }
                
                if (!name) {
                    alert('אנא הכנס שם לתת נושא');
                    nameInput.focus();
                    return;
                }
                
                const topic = appData.mainTopics.find(t => t.id === topicId);
                if (!topic) {
                    alert('שגיאה: נושא לא נמצא');
                    return;
                }
                
                if (!topic.subTopics) {
                    topic.subTopics = [];
                }
                
                const newId = getMaxSubTopicId() + 1;
                
                const newSubTopic = {
                    id: newId,
                    name: name,
                    driveLink: driveLink || '',
					fileOwner: fileOwner || '',
                    subTopics: []
                };
                
                // הוספה למקום הנכון
                if (parentId) {
                    const parentSubTopic = findSubTopicById(topic.subTopics, parentId);
                    if (parentSubTopic) {
                        if (!parentSubTopic.subTopics) {
                            parentSubTopic.subTopics = [];
                        }
                        parentSubTopic.subTopics.push(newSubTopic);
                    }
                } else {
                    topic.subTopics.push(newSubTopic);
                }
                
                nameInput.value = '';
                linkInput.value = '';
				ownerInput.value = '';
                
                saveDataToFirebase();
                renderParentSelect();
                renderSubTopics();
                
                alert('תת נושא נוסף בהצלחה!');
                
            } catch (error) {
                console.error('Error in addSubTopic:', error);
                alert('שגיאה: ' + error.message);
            }
        }

        // הוספת תת נושא מקונן
        function addNestedSubTopic(parentId) {
            const topicSelect = document.getElementById('topic-select');
            const selectedTopicId = topicSelect.value;
            
            if (!selectedTopicId) {
                alert('אנא בחר נושא ראשי');
                return;
            }
            
            // מילוי אוטומטי של הנושא העליון
            const parentSelect = document.getElementById('parent-select');
            parentSelect.value = parentId;
            
            // מיקוד בשדה השם
            document.getElementById('new-sub-topic').focus();
            
            const parentSubTopic = findSubTopicById(appData.mainTopics.find(t => t.id == selectedTopicId).subTopics, parentId);
            if (parentSubTopic) {
                showSuccess('כעת תוכל להוסיף תת נושא תחת "' + parentSubTopic.name + '"');
            }
        }

        // מחיקת נושא ראשי
        function deleteMainTopic(topicId) {
            if (confirm('האם אתה בטוח שברצונך למחוק את הנושא? כל תתי הנושאים יימחקו גם כן.')) {
                appData.mainTopics = appData.mainTopics.filter(t => t.id !== topicId);
                saveDataToFirebase();
                renderMainTopics();
                renderAdminPanel();
            }
        }

        // מחיקת תת נושא
        function deleteSubTopic(topicId, subTopicId) {
            const topic = appData.mainTopics.find(t => t.id === topicId);
            if (!topic) return;
            
            const result = findSubTopicWithParent(topic.subTopics, subTopicId);
            if (!result) return;
            
            const { subTopic, parent } = result;
            const hasSubTopics = subTopic.subTopics && subTopic.subTopics.length > 0;
            
            let confirmMessage = `האם אתה בטוח שברצונך למחוק את "${subTopic.name}"?`;
            if (hasSubTopics) {
                confirmMessage += `\n\nשים לב: הנושא הזה מכיל ${subTopic.subTopics.length} תתי נושאים שגם יימחקו!`;
            }
            
            if (confirm(confirmMessage)) {
                if (parent) {
                    // מחיקה מתוך הורה
                    parent.subTopics = parent.subTopics.filter(st => st.id !== subTopicId);
                } else {
                    // מחיקה מהרמה הראשונה
                    topic.subTopics = topic.subTopics.filter(st => st.id !== subTopicId);
                }
                
                saveDataToFirebase();
                renderParentSelect();
                renderSubTopics();
                showSuccess(`"${subTopic.name}" נמחק בהצלחה!`);
            }
        }

        // אירועי מקלדת - מתוקן
        document.addEventListener('DOMContentLoaded', function() {
            // Enter בשדה הערה
            document.getElementById('comment-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addComment();
                }
            });

            // Enter בשם משתמש
            document.getElementById('user-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('comment-input').focus();
                }
            });

            // Enter בהוספת נושא ראשי
            document.getElementById('new-main-topic').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addMainTopic();
                }
            });

            // Enter בהוספת תת נושא
            document.getElementById('new-sub-topic').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('new-drive-link').focus();
                }
            });

            // Enter בקישור גוגל דרייב - מתוקן
            document.getElementById('new-drive-link').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('new-file-owner').focus();
                }
            });

            // Enter בשם בעל הקובץ - חדש
            document.getElementById('new-file-owner').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addSubTopic();
                }
            });

            // Enter בסיסמת מנהל
            document.getElementById('admin-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    adminLogin();
                }
            });
			// Enter בשדות שינוי סיסמה
            document.getElementById('current-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('new-password').focus();
                }
            });
            
            document.getElementById('new-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('confirm-password').focus();
                }
            });
            
            document.getElementById('confirm-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    changeAdminPassword();
                }
            });
        });
// פונקציה לשינוי סיסמת מנהל
        async function changeAdminPassword() {
            const currentPasswordInput = document.getElementById('current-password');
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const changeBtn = document.getElementById('change-password-btn');
            const errorDiv = document.getElementById('password-change-error');
            const successDiv = document.getElementById('password-change-success');
            
            // נקה הודעות קודמות
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            const currentPassword = currentPasswordInput.value.trim();
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();
            
            // בדיקות תקינות
            if (!currentPassword || !newPassword || !confirmPassword) {
                showPasswordError('יש למלא את כל השדות');
                return;
            }
            
            if (newPassword.length < 6) {
                showPasswordError('הסיסמה החדשה חייבת להכיל לפחות 6 תווים');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showPasswordError('הסיסמה החדשה ואימוד הסיסמה לא תואמים');
                return;
            }
            
            if (newPassword === currentPassword) {
                showPasswordError('הסיסמה החדשה חייבת להיות שונה מהנוכחית');
                return;
            }
            
            changeBtn.disabled = true;
            changeBtn.textContent = 'משנה סיסמה...';
            
            try {
                if (!firebaseInitialized) {
                    showPasswordError('שגיאה: מערכת לא מחוברת לבסיס הנתונים');
                    return;
                }
                
                // בדוק את הסיסמה הנוכחית
                const snapshot = await database.ref('adminPassword').once('value');
                if (!snapshot.exists()) {
                    showPasswordError('שגיאה: לא נמצאה סיסמת מנהל');
                    return;
                }
                
                const storedHash = snapshot.val();
                const currentPasswordHash = await hashPassword(currentPassword);
                
                if (storedHash !== currentPasswordHash) {
                    showPasswordError('הסיסמה הנוכחית שגויה');
                    return;
                }
                
                // הצפן ושמור את הסיסמה החדשה
                const newPasswordHash = await hashPassword(newPassword);
                await database.ref('adminPassword').set(newPasswordHash);
                
                // נקה את השדות
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
                
                showPasswordSuccess('הסיסמה שונתה בהצלחה! 🎉');
                console.log('סיסמת המנהל שונתה בהצלחה');
                
            } catch (error) {
                console.error('שגיאה בשינוי סיסמה:', error);
                showPasswordError('שגיאה בשינוי הסיסמה. אנא נסה שוב.');
            } finally {
                changeBtn.disabled = false;
                changeBtn.textContent = 'שנה סיסמה';
            }
        }

        // פונקציות עזר להצגת הודעות
        function showPasswordError(message) {
            const errorDiv = document.getElementById('password-change-error');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        function showPasswordSuccess(message) {
            const successDiv = document.getElementById('password-change-success');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 5000);
            }
        }
        // אתחול האתר
        initApp();
    </script>
</body>
</html>