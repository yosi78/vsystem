<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×”×©××œ×ª ××—×©×‘×™×</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            min-height: 90vh;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }
        
        .connection-status {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 5px 5px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .connection-status.connected {
            background: rgba(76, 175, 80, 0.8);
        }
        
        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.8);
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        
        .content {
            padding: 30px 25px;
            flex: 1;
        }
        
        /* Footer Styles */
        .footer {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: auto;
            border-radius: 0 0 20px 20px;
        }
        
        .footer-name {
            font-size: 1.0em;
            font-weight: bold;
            color: #ecf0f1;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
        }
        
        .footer-name:hover {
            color: #3498db;
            transform: scale(1.05);
            text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        
        .footer-copyright {
            font-size: 0.8em;
            color: #bdc3c7;
            opacity: 0.8;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .main-options {
            text-align: center;
            margin-top: 60px;
        }
        
        .main-options h2 {
            color: #333;
            margin-bottom: 40px;
            font-size: 1.6em;
        }
        
        .option-btn {
            width: 100%;
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 25px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .option-btn:hover {
            transform: translateY(-3px);
        }
        
        .option-btn.return {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .step {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 8px;
            font-weight: bold;
            position: relative;
        }
        
        .step.active {
            background: #4CAF50;
            color: white;
        }
        
        .step.completed {
            background: #2196F3;
            color: white;
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 100%;
            top: 50%;
            width: 16px;
            height: 2px;
            background: #ddd;
            transform: translateY(-50%);
        }
        
        .step.completed:not(:last-child)::after {
            background: #4CAF50;
        }
        
        .screen-title {
            text-align: center;
            color: #333;
            font-size: 1.4em;
            margin-bottom: 30px;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 1em;
            background: white;
        }
        
        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .computer-section {
            margin-top: 20px;
        }
        
        .computer-count-info {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            color: #2e7d32;
        }

        .availability-warning {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            color: #e65100;
        }

        .multi-cart-section {
            background: #f3e5f5;
            border: 1px solid #9c27b0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .cart-selection-item {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cart-selection-item:hover {
            border-color: #9c27b0;
            background: #fafafa;
        }

        .cart-selection-item.selected {
            border-color: #9c27b0;
            background: #f3e5f5;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .cart-name {
            font-weight: bold;
            color: #333;
        }

        .cart-availability {
            font-size: 0.9em;
            color: #666;
        }

        .cart-computers-input {
            display: none;
            margin-top: 15px;
        }

        .cart-computers-input.show {
            display: block;
        }
        
        .computer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .computer-checkbox {
            display: none;
        }
        
        .computer-label {
            display: block;
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
        }
        
        .computer-label:hover {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        
        .computer-checkbox:checked + .computer-label {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .computer-checkbox:disabled + .computer-label {
            background: #ffcdd2;
            color: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ×¡×’× ×•×Ÿ ×—×“×© ×œ×—×œ×§ ×”×”×©××œ×” ×”×§×‘×•×¢×” */
        .recurring-loan-section {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            transition: all 0.3s ease;
        }

        .recurring-loan-section.active {
            background: #e8f5e8;
            border-color: #4CAF50;
        }

        .recurring-checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .recurring-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .recurring-label {
            font-size: 1.1em;
            font-weight: bold;
            color: #1976D2;
            cursor: pointer;
            margin: 0;
        }

        .recurring-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            display: none;
        }

        .recurring-info.show {
            display: block;
        }

        .recurring-warning {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            color: #e65100;
            font-size: 0.9em;
            display: none;
        }

        .recurring-warning.show {
            display: block;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 40px;
        }
        
        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #757575, #616161);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
            font-size: 0.9em;
            padding: 8px 12px;
            margin-right: 10px;
            min-width: auto;
            flex: none;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.8em;
            margin: 5px;
        }

        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }
        
        .success-content {
            text-align: center;
            padding: 40px 20px;
        }
        
        .success-icon {
            font-size: 4em;
            color: #4CAF50;
            margin-bottom: 20px;
        }
        
        .success-content h2 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .success-content p {
            color: #666;
            margin-bottom: 30px;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-right: 4px solid #f44336;
        }

        .loans-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 15px;
        }

        .loan-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .loan-item:hover {
            background-color: #f5f5f5;
        }

        .loan-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
        }

        .loan-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .loan-details {
            font-size: 0.9em;
            color: #666;
        }

        .no-loans {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }

        .loan-management-item {
            background: white; 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 5px; 
            border-right: 4px solid #4caf50; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }

        .loan-management-item.future {
            border-right-color: #4caf50;
        }

        .loan-management-item.current {
            border-right-color: #ff9800;
        }

        .loan-management-item.recurring {
            border-right-color: #9c27b0;
            background: #f3e5f5;
        }

        /* ×¡×’× ×•× ×•×ª ×—×“×©×™× ×œ× ×™×”×•×œ ×ª×¦×•×¨×” */
        .management-tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .management-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            transition: all 0.3s ease;
        }

        .management-tab.active {
            background: #4CAF50;
            color: white;
        }

        .management-tab:hover:not(.active) {
            background: #e8f5e8;
        }

        .management-content {
            display: none;
        }

        .management-content.active {
            display: block;
        }

        .config-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .config-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-item-content {
            flex: 1;
        }

        .config-item-actions {
            display: flex;
            gap: 10px;
        }

        .config-form {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-form h4 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .config-form .form-group {
            margin-bottom: 15px;
        }

        .config-form input,
        .config-form select {
            padding: 10px;
            font-size: 0.9em;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group > * {
            flex: 1;
        }

        .list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .list-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background: #f5f5f5;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-actions {
            display: flex;
            gap: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #4CAF50;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .content {
                padding: 20px;
            }
            
            .computer-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
            
            .connection-status {
                position: static;
                display: inline-block;
                margin-bottom: 10px;
            }

            .management-tabs {
                flex-direction: column;
            }

            .config-item {
                flex-direction: column;
                gap: 10px;
            }

            .config-item-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="connection-status" id="connectionStatus">ğŸ”„ ××ª×—×‘×¨×ª...</div>
			<h1>ğŸ–¥ï¸ ××¢×¨×›×ª ×”×©××œ×ª ××—×©×‘×™×</h1>
            <p>version 0.3</p>
        </div>
        
        <div class="content">
            <!-- ××¡×š ×¨××©×™ -->
            <div id="mainScreen" class="screen active">
                <div class="main-options">
                    <h2>×‘×—×¨×™ ×¤×¢×•×œ×”</h2>
                    <button class="option-btn" id="loanBtn">
                        ğŸ“ ×”×©××œ×ª ××—×©×‘×™×
                    </button>
                    <button class="option-btn return" id="returnBtn">
                        â†©ï¸ ×”×—×–×¨×ª ××—×©×‘×™×
                    </button>
                    <button class="option-btn" id="managementBtn" style="background: linear-gradient(45deg, #9C27B0, #7B1FA2);">
                        âš™ï¸ × ×™×”×•×œ
                    </button>
                </div>
            </div>
            
            <!-- ××¡×š 1: ×¤×¨×˜×™ ××•×¨×” -->
            <div id="teacherScreen" class="screen">
                <div class="step-indicator">
                    <div class="step active">1</div>
                    <div class="step">2</div>
                    <div class="step">3</div>
                </div>
                
                <h2 class="screen-title">×¤×¨×˜×™ ×”××•×¨×”</h2>
                
                <div class="form-group">
                    <label for="teacherName">×©× ×”××•×¨×”:</label>
                    <select id="teacherName" required>
                        <option value="">×‘×—×¨×™ ××•×¨×”...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="teacherClass">×›×™×ª×”:</label>
                    <select id="teacherClass" required>
                        <option value="">×‘×—×¨×™ ×›×™×ª×”...</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="backToMain1">×—×–×¨×”</button>
                    <button class="btn btn-primary" id="nextToDate">×”×‘×</button>
                </div>
            </div>
            
            <!-- ××¡×š 2: ×ª××¨×™×š ×•×©×¢×” -->
            <div id="dateScreen" class="screen">
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step active">2</div>
                    <div class="step">3</div>
                </div>
                
                <h2 class="screen-title">×ª××¨×™×š ×•×©×¢×ª ×”×©××œ×”</h2>
                
                <div class="form-group">
                    <label for="loanDate">×ª××¨×™×š ×”×©××œ×”:</label>
                    <input type="date" id="loanDate" required>
                </div>
                
                <div class="form-group">
                    <label for="loanTime">×©×¢×ª ×”×©××œ×”:</label>
                    <select id="loanTime" required>
                        <option value="">×‘×—×¨×™ ×©×¢×”...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="computerCount">××¡×¤×¨ ××—×©×‘×™× ××‘×•×§×©:</label>
                    <select id="computerCount" required>
                        <option value="">×‘×—×¨×™ ×›××•×ª...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="expectedReturnTime">×©×¢×ª ×”×—×–×¨×” ××ª×•×›× × ×ª:</label>
                    <select id="expectedReturnTime" required>
                        <option value="">×‘×—×¨×™ ×©×¢×”...</option>
                    </select>
                </div>

                <!-- ×—×œ×§ ×—×“×© - ×”×©××œ×” ×§×‘×•×¢×” -->
                <div class="recurring-loan-section" id="recurringSection">
                    <div class="recurring-checkbox-container">
                        <input type="checkbox" id="isRecurringLoan" class="recurring-checkbox">
                        <label for="isRecurringLoan" class="recurring-label">ğŸ”„ ×”×©××œ×” ×§×‘×•×¢×”</label>
                    </div>
                    
                    <div class="recurring-info" id="recurringInfo">
                        <strong>ğŸ’¡ ×”×©××œ×” ×§×‘×•×¢×”:</strong><br>
                        ×”××—×©×‘×™× ×™×”×™×• ×©××•×¨×™× ××•×˜×•××˜×™×ª ×›×œ ×©×‘×•×¢ ×‘××•×ª×• ×™×•× ×•×©×¢×”.<br>
                        ×œ×“×•×’××”: ×× ×ª×‘×—×¨×™ ×™×•× ×¨×‘×™×¢×™ ×‘×©×¢×” 09:00, ×”××—×©×‘×™× ×™×”×™×• ×ª×¤×•×¡×™× ×‘×›×œ ×™×•× ×¨×‘×™×¢×™ ×‘×©×¢×” ×–×•.
                    </div>

                    <div class="recurring-warning" id="recurringWarning">
                        âš ï¸ <strong>×©×™××™ ×œ×‘:</strong> ×”×©××œ×” ×§×‘×•×¢×” ×ª×—×¡×•× ××ª ×”××—×©×‘×™× ×‘×›×œ ×”×©×‘×•×¢×•×ª ×”×‘××™×!<br>
                        ×•×•×“××™ ×©×–×” ×‘×××ª × ×“×¨×© ×œ×¤× ×™ ×©×ª××©×™×›×™.
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="backToTeacher">×—×–×¨×”</button>
                    <button class="btn btn-primary" id="nextToComputer">×”×‘×</button>
                </div>
            </div>
            
            <!-- ××¡×š 3: ×‘×—×™×¨×ª ××—×©×‘×™× -->
            <div id="computerScreen" class="screen">
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step completed">2</div>
                    <div class="step active">3</div>
                </div>
                
                <h2 class="screen-title">×‘×—×™×¨×ª ××—×©×‘×™×</h2>
                
                <!-- ××¡×š ×‘×—×™×¨×” ×¨×’×™×œ ××¢×’×œ×” ××—×ª -->
                <div id="singleCartSelection">
                    <div class="form-group">
                        <label for="cartSelect">×¢×’×œ×”:</label>
                        <select id="cartSelect" required>
                            <option value="">×‘×—×¨×™ ×¢×’×œ×”...</option>
                        </select>
                    </div>
                    
                    <div class="computer-section" id="computerSection" style="display: none;">
                        <h4>×‘×—×¨ ××—×©×‘×™× ×–××™× ×™×:</h4>
                        <div class="computer-count-info" id="computerCountInfo">
                            × ×‘×—×¨×•: 0 ××ª×•×š <span id="requiredCount">0</span>
                        </div>
                        <div class="computer-grid" id="computerGrid"></div>
                    </div>
                </div>

                <!-- ××¡×š ×‘×—×™×¨×” ××›××” ×¢×’×œ×•×ª -->
                <div id="multiCartSelection" style="display: none;">
                    <div class="availability-warning" id="availabilityWarning">
                        âš ï¸ ××™×Ÿ ××¡×¤×™×§ ××—×©×‘×™× ×–××™× ×™× ×‘×¢×’×œ×” ××—×ª. ×× × ×‘×—×¨ ××›××” ×¢×’×œ×•×ª:
                    </div>
                    
                    <div class="multi-cart-section">
                        <h4>×‘×—×™×¨×ª ×¢×’×œ×•×ª ×•××—×©×‘×™×:</h4>
                        <div id="multiCartContainer"></div>
                        
                        <div class="computer-count-info" id="multiComputerCountInfo">
                            × ×‘×—×¨×•: 0 ××ª×•×š <span id="multiRequiredCount">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="backToDate">×—×–×¨×”</button>
                    <button class="btn btn-primary" id="submitLoan" disabled>×©×œ×—×™</button>
                </div>
            </div>
            
            <!-- ××¡×š ×¡×™×¡××ª × ×™×”×•×œ -->
            <div id="passwordScreen" class="screen">
                <h2 class="screen-title">ğŸ” ×”×–×“×”×•×ª ×× ×”×œ</h2>
                
                <div class="form-group">
                    <label for="adminPassword">×”×›× ×¡ ×¡×™×¡××ª × ×™×”×•×œ:</label>
                    <input type="password" id="adminPassword" placeholder="×¡×™×¡××”...">
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="backToMainFromPassword">×—×–×¨×”</button>
                    <button class="btn btn-primary" id="submitPassword">×›× ×™×¡×”</button>
                </div>
            </div>
            
            <!-- ××¡×š × ×™×”×•×œ -->
            <div id="managementScreen" class="screen">
                <h2 class="screen-title">âš™ï¸ ××¡×š × ×™×”×•×œ</h2>
                
                <!-- ×˜××‘×™× ×œ× ×™×”×•×œ -->
                <div class="management-tabs">
                    <button class="management-tab active" onclick="switchManagementTab('overview')">ğŸ“Š ×¡×§×™×¨×”</button>
                    <button class="management-tab" onclick="switchManagementTab('teachers')">ğŸ‘©â€ğŸ« ××•×¨×•×ª</button>
                    <button class="management-tab" onclick="switchManagementTab('times')">â° ×©×¢×•×ª</button>
                    <button class="management-tab" onclick="switchManagementTab('carts')">ğŸ›’ ×¢×’×œ×•×ª</button>
                    <button class="management-tab" onclick="switchManagementTab('computers')">ğŸ–¥ï¸ ××—×©×‘×™×</button>
                    <button class="management-tab" onclick="switchManagementTab('reports')">ğŸ“‹ ×“×•×—×•×ª</button>
                </div>

                <!-- ×ª×•×›×Ÿ ×”×¡×§×™×¨×” -->
                <div id="overviewContent" class="management-content active">
                    <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª ×›×œ×œ×™×•×ª -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalComputers">0</div>
                            <div class="stat-label">×¡×”"×› ××—×©×‘×™×</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="loanedComputers">0</div>
                            <div class="stat-label">××•×©××œ×™× ×›×¨×’×¢</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="availableComputers">0</div>
                            <div class="stat-label">×–××™× ×™×</div>
                        </div>
                    </div>
                    
                    <!-- ×”×©××œ×•×ª × ×•×›×—×™×•×ª -->
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #f57c00; margin-bottom: 10px;">ğŸ”„ ×”×©××œ×•×ª ×¤×¢×™×œ×•×ª ×›×¨×’×¢</h3>
                        <div id="currentLoans">
                            <div style="text-align: center; color: #999; font-style: italic;">××™×Ÿ ×”×©××œ×•×ª ×¤×¢×™×œ×•×ª</div>
                        </div>
                    </div>
                    
                    <!-- ×”×©××œ×•×ª ×§×‘×•×¢×•×ª -->
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #7b1fa2; margin-bottom: 10px;">ğŸ”„ ×”×©××œ×•×ª ×§×‘×•×¢×•×ª</h3>
                        <div id="recurringLoans">
                            <div style="text-align: center; color: #999; font-style: italic;">××™×Ÿ ×”×©××œ×•×ª ×§×‘×•×¢×•×ª</div>
                        </div>
                    </div>
                    
                    <!-- ×”×©××œ×•×ª ×¢×ª×™×“×™×•×ª -->
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #2e7d32; margin-bottom: 10px;">ğŸ“… ×”×©××œ×•×ª ×¢×ª×™×“×™×•×ª</h3>
                        <div id="futureLoans">
                            <div style="text-align: center; color: #999; font-style: italic;">××™×Ÿ ×”×©××œ×•×ª ××ª×•×›× × ×•×ª</div>
                        </div>
                    </div>
                    
                    <!-- ×¤×™×¨×•×˜ ×œ×¤×™ ×¢×’×œ×•×ª -->
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #7b1fa2; margin-bottom: 10px;">ğŸ›’ ××¦×‘ ×¢×’×œ×•×ª</h3>
                        <div id="cartStatus"></div>
                    </div>
                </div>

                <!-- ×ª×•×›×Ÿ × ×™×”×•×œ ××•×¨×•×ª -->
                <div id="teachersContent" class="management-content">
                    <div class="config-section">
                        <h3>ğŸ‘©â€ğŸ« × ×™×”×•×œ ××•×¨×•×ª</h3>
                        
                        <div class="config-form" id="teacherForm" style="display: none;">
                            <h4 id="teacherFormTitle">×”×•×¡×¤×ª ××•×¨×” ×—×“×©×”</h4>
                            <div class="form-group">
                                <label for="teacherNameInput">×©× ×”××•×¨×”:</label>
                                <input type="text" id="teacherNameInput" placeholder="×”×›× ×¡ ×©× ××•×¨×”...">
                            </div>
                            <div class="form-group">
                                <label for="teacherClassInput">×›×™×ª×”:</label>
                                <select id="teacherClassInput">
                                    <option value="">×‘×—×¨ ×›×™×ª×”...</option>
                                </select>
                            </div>
                            <div class="button-group">
                                <button class="btn btn-secondary" onclick="cancelTeacherForm()">×‘×™×˜×•×œ</button>
                                <button class="btn btn-success" onclick="saveTeacher()">×©××•×¨</button>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn btn-success" onclick="showAddTeacherForm()">â• ×”×•×¡×£ ××•×¨×”</button>
                        </div>
                        
                        <div class="list-container" id="teachersList">
                            <!-- ××•×¨×•×ª ×™×•×¦×’×• ×›××Ÿ -->
                        </div>
                    </div>
                </div>

                <!-- ×ª×•×›×Ÿ × ×™×”×•×œ ×©×¢×•×ª -->
                <div id="timesContent" class="management-content">
                    <div class="config-section">
                        <h3>â° × ×™×”×•×œ ×©×¢×•×ª ×”×©××œ×”</h3>
                        
                        <div class="config-form" id="timeForm" style="display: none;">
                            <h4 id="timeFormTitle">×”×•×¡×¤×ª ×©×¢×” ×—×“×©×”</h4>
                            <div class="form-group">
                                <label for="timeInput">×©×¢×”:</label>
                                <input type="time" id="timeInput">
                            </div>
                            <div class="button-group">
                                <button class="btn btn-secondary" onclick="cancelTimeForm()">×‘×™×˜×•×œ</button>
                                <button class="btn btn-success" onclick="saveTime()">×©××•×¨</button>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn btn-success" onclick="showAddTimeForm()">â• ×”×•×¡×£ ×©×¢×”</button>
                        </div>
                        
                        <div class="list-container" id="timesList">
                            <!-- ×©×¢×•×ª ×™×•×¦×’×• ×›××Ÿ -->
                        </div>
                    </div>
                </div>

                <!-- ×ª×•×›×Ÿ × ×™×”×•×œ ×¢×’×œ×•×ª -->
                <div id="cartsContent" class="management-content">
                    <div class="config-section">
                        <h3>ğŸ›’ × ×™×”×•×œ ×¢×’×œ×•×ª</h3>
                        
                        <div class="config-form" id="cartForm" style="display: none;">
                            <h4 id="cartFormTitle">×”×•×¡×¤×ª ×¢×’×œ×” ×—×“×©×”</h4>
                            <div class="form-group">
                                <label for="cartNameInput">×©× ×”×¢×’×œ×”:</label>
                                <input type="text" id="cartNameInput" placeholder="×œ××©×œ: ×¢×’×œ×” #1">
                            </div>
                            <div class="form-group">
                                <label for="cartDescriptionInput">×ª×™××•×¨:</label>
                                <input type="text" id="cartDescriptionInput" placeholder="×œ××©×œ: CHROME BOOKS">
                            </div>
                            <div class="form-group">
                                <label for="cartPrefixInput">×§×™×“×•××ª ××—×©×‘×™×:</label>
                                <input type="text" id="cartPrefixInput" placeholder="×œ××©×œ: #1">
                            </div>
                            <div class="form-group">
                                <label for="cartCountInput">××¡×¤×¨ ××—×©×‘×™×:</label>
                                <input type="number" id="cartCountInput" min="1" max="50" placeholder="24">
                            </div>
                            <div class="button-group">
                                <button class="btn btn-secondary" onclick="cancelCartForm()">×‘×™×˜×•×œ</button>
                                <button class="btn btn-success" onclick="saveCart()">×©××•×¨</button>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn btn-success" onclick="showAddCartForm()">â• ×”×•×¡×£ ×¢×’×œ×”</button>
                        </div>
                        
                        <div class="list-container" id="cartsList">
                            <!-- ×¢×’×œ×•×ª ×™×•×¦×’×• ×›××Ÿ -->
                        </div>
                    </div>
                </div>

                <!-- ×ª×•×›×Ÿ × ×™×”×•×œ ××—×©×‘×™× -->
                <div id="computersContent" class="management-content">
                    <div class="config-section">
                        <h3>ğŸ–¥ï¸ × ×™×”×•×œ ××—×©×‘×™×</h3>
                        
                        <div class="form-group">
                            <label for="cartSelectForComputers">×‘×—×¨ ×¢×’×œ×”:</label>
                            <select id="cartSelectForComputers" onchange="loadComputersForCart()">
                                <option value="">×‘×—×¨ ×¢×’×œ×”...</option>
                            </select>
                        </div>
                        
                        <div id="computerManagementSection" style="display: none;">
                            <div class="config-form" id="computerForm" style="display: none;">
                                <h4 id="computerFormTitle">×”×•×¡×¤×ª ××—×©×‘ ×—×“×©</h4>
                                <div class="form-group">
                                    <label for="computerNameInput">×©× ×”××—×©×‘:</label>
                                    <input type="text" id="computerNameInput" placeholder="×œ××©×œ: #1-001">
                                </div>
                                <div class="button-group">
                                    <button class="btn btn-secondary" onclick="cancelComputerForm()">×‘×™×˜×•×œ</button>
                                    <button class="btn btn-success" onclick="saveComputer()">×©××•×¨</button>
                                </div>
                            </div>
                            
                            <div class="button-group">
                                <button class="btn btn-success" onclick="showAddComputerForm()">â• ×”×•×¡×£ ××—×©×‘</button>
                                <button class="btn btn-warning" onclick="regenerateComputers()">ğŸ”„ ×™×¦×•×¨ ××—×“×©</button>
                            </div>
                            
                            <div class="list-container" id="computersList">
                                <!-- ××—×©×‘×™× ×™×•×¦×’×• ×›××Ÿ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ×ª×•×›×Ÿ ×“×•×—×•×ª -->
                <div id="reportsContent" class="management-content">
                    <div class="config-section">
                        <h3>ğŸ“‹ ×“×•×—×•×ª</h3>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="totalReturns">0</div>
                                <div class="stat-label">×¡×”"×› ×”×—×–×¨×•×ª</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="returnsWithNotes">0</div>
                                <div class="stat-label">×”×—×–×¨×•×ª ×¢× ×”×¢×¨×•×ª</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="activeLoansCount">0</div>
                                <div class="stat-label">×”×©××œ×•×ª ×¤×¢×™×œ×•×ª</div>
                            </div>
                        </div>

                        <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h4 style="color: #1976d2; margin-bottom: 15px;">ğŸ“Š ×™×™×¦×•× ×“×•×—×•×ª</h4>
                            
                            <div class="form-group">
                                <label for="reportDateFrom">××ª××¨×™×š:</label>
                                <input type="date" id="reportDateFrom">
                            </div>
                            
                            <div class="form-group">
                                <label for="reportDateTo">×¢×“ ×ª××¨×™×š:</label>
                                <input type="date" id="reportDateTo">
                            </div>
                            
                            <div class="button-group">
                                <button class="btn btn-success" onclick="exportReturnNotesToExcel()">
                                    ğŸ“Š ×™×™×¦× ×”×¢×¨×•×ª ×”×—×–×¨×” ×œ××§×¡×œ
                                </button>
                                <button class="btn btn-info" onclick="exportAllLoansToExcel()">
                                    ğŸ“‹ ×™×™×¦× ×›×œ ×”×”×©××œ×•×ª ×œ××§×¡×œ
                                </button>
                            </div>
                        </div>

                        <div style="background: #fff3e0; padding: 20px; border-radius: 12px;">
                            <h4 style="color: #f57c00; margin-bottom: 15px;">ğŸ“ ×”×¢×¨×•×ª ×”×—×–×¨×” ×”××—×¨×•× ×•×ª</h4>
                            <div id="recentReturnNotes">
                                <!-- ×”×¢×¨×•×ª ×™×•×¦×’×• ×›××Ÿ -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="backToMainFromManagement">×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™</button>
                    <button class="btn btn-primary" id="refreshManagement">ğŸ”„ ×¨×¢× ×•×Ÿ × ×ª×•× ×™×</button>
                </div>
            </div>
            
            <!-- ××¡×š ×”×—×–×¨×” - ×©×œ×‘ 1: ×‘×—×™×¨×ª ××•×¨×” -->
            <div id="returnTeacherScreen" class="screen">
                <div class="step-indicator">
                    <div class="step active">1</div>
                    <div class="step">2</div>
                </div>
                
                <h2 class="screen-title">×”×—×–×¨×ª ××—×©×‘×™× - ×‘×—×™×¨×ª ××•×¨×”</h2>
                
                <div class="form-group">
                    <label for="returnTeacher">××™×–×• ××•×¨×” ××—×–×™×¨×” ××—×©×‘×™×:</label>
                    <select id="returnTeacher" required>
                        <option value="">×‘×—×¨×™ ××•×¨×”...</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="backToMainFromReturn1">×—×–×¨×”</button>
                    <button class="btn btn-primary" id="nextToReturnLoanSelect">×”×‘×</button>
                </div>
            </div>
            
            <!-- ××¡×š ×”×—×–×¨×” - ×©×œ×‘ 2: ×‘×—×™×¨×ª ×”×©××œ×” -->
            <div id="returnLoanSelectScreen" class="screen">
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step active">2</div>
                </div>
                
                <h2 class="screen-title">×‘×—×™×¨×ª ×”×©××œ×” ×œ×”×—×–×¨×”</h2>
                
                <div class="form-group">
                    <label>×”×©××œ×•×ª ×¤×¢×™×œ×•×ª ×©×œ <span id="selectedTeacherName"></span>:</label>
                    <div class="loans-list" id="activeLoansList">
                        <div class="no-loans">×˜×•×¢× ×ª ×”×©××œ×•×ª...</div>
                    </div>
                </div>
                
                <div class="form-group" id="returnDetailsSection" style="display: none;">
                    <label for="returnDate">×ª××¨×™×š ×”×—×–×¨×”:</label>
                    <input type="date" id="returnDate" required>
                </div>
                
                <div class="form-group" id="returnTimeSection" style="display: none;">
                    <label for="returnTime">×©×¢×ª ×”×—×–×¨×”:</label>
                    <select id="returnTime" required>
                        <option value="">×‘×—×¨×™ ×©×¢×”...</option>
                    </select>
                </div>
                
                <div class="form-group" id="returnNotesSection" style="display: none;">
                    <label for="returnNotes">×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™):</label>
                    <textarea id="returnNotes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="backToReturnTeacher">×—×–×¨×”</button>
                    <button class="btn btn-primary" id="submitReturn" disabled>××©×¨×™ ×”×—×–×¨×”</button>
                </div>
            </div>
            
            <!-- ××¡×š ×”×¦×œ×—×” -->
            <div id="successScreen" class="screen">
                <div class="success-content">
                    <div class="success-icon">âœ…</div>
                    <h2 id="successTitle">××•×©×¨×” ×”×‘×§×©×”!</h2>
                    <p id="successMessage">×”×‘×§×©×” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×•× ×¨×©××” ×‘××¢×¨×›×ª.</p>
                    <button class="btn btn-primary" id="backToMainSuccess">×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™</button>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <a href="mailto:yosiel3@gmail.com?subject=×‘× ×•×’×¢ ×œ××¢×¨×›×ª ×”×©××œ×ª ××—×©×‘×™×&body=×©×œ×•× ×™×•×¡×™," class="footer-name">ByteLogicx</a>
            <div class="footer-copyright">Â© 2023 ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
			apiKey: "AIzaSyAbjHl-0nafBGZpUg3-4jEWdr5qupAIurs",
			authDomain: "sokolov-lap.firebaseapp.com",
			databaseURL: "https://sokolov-lap-default-rtdb.firebaseio.com",
			projectId: "sokolov",
			storageBucket: "sokolov-lap.firebasestorage.app",
			messagingSenderId: "752501526935",
			appId: "1:752501526935:web:b9fc629fe8992f51b4b4d2",
			measurementId: "G-MYZ4T71E80"
		};


        // Global Variables
        let app, database;
        let isConnected = false;
        let systemData = {
            carts: {},
            loans: [],
            recurringLoans: [],
            config: {
                teachers: [],
                classes: [],
                timeSlots: [],
                computerCountOptions: []
            }
        };
        
        let currentLoan = {};
        let selectedComputers = [];
        let selectedLoanForReturn = null;
        let isMultiCartMode = false;
        let selectedCarts = {};
        let editingItem = null;
        let activeManagementTab = 'overview';
        
        // Default configuration (fallback)
        const defaultConfig = {
            teachers: [
                "××•×“×œ×™×” ××‘×™×‘×™", "××¡×× ××‘×• ×•××¡×œ", "×’×œ ××•×¨×•×Ÿ", "××™×™×œ×ª ×¨×•×–× ×©×˜×™×™×Ÿ",
                "×“×“×™ ×”×¨××œ", "××™×¨×™×¡ ×–×•×”×¨", "×™×•×¡×™ ××œ×¢×–×¨", "×©×™ ×›×¨××œ×™",
                "× ×¢××” ×œ×‘×™×‘", "×œ×‘× ×ª ×©×§×“", "×œ×™××•×¨ ×œ×•×™", "×œ×™××•×¨ ×©×œ××”",
                "× ×¢××” ×œ×¡×¨×™", "×”×™×œ×” ××’×“", "××•×¨ ××œ×§×‘×¥", "××•×¨×Ÿ ×¢×–×•×¨×”",
                "××™×¡× ××’×‘××¨×™×”", "×”×•×“ × ×•×£", "× ×•×¨ ×’×œ×‘×•×¢", "××™×” ×¡×”×¨",
                "×¡×™×•×Ÿ ×›×™××˜", "×•×¨×“ ×¢×˜×¨", "×™×¢×œ ×¢×™× ×ª", "×¢× ×ª ×× ×“×¨×¡×•×Ÿ",
                "×§×¨×™×Ÿ ×¤×¤×¨", "×¨×•×ª×™ ×“×™×‘×©×™", "×©× ×™ ×©×‘×ª××™", "×˜×œ ×©×—×¨",
                "×“× ×” ×©×˜×¨× ××•", "×“× ×” ×©×™×™×§×•×‘×™×¥", "×©××¨×™×ª ××”×¨×•× ×™"
            ],
            classes: ["×'", "×‘'", "×’'", "×“'", "×”'", "×•'"],
            timeSlots: [
                "08:00", "09:00", "09:50", "11:00", "12:00",
                "12:50", "13:30", "14:15", "15:00"
            ],
            computerCountOptions: [
                { value: 1, label: "1 ××—×©×‘" },
                { value: 2, label: "2 ××—×©×‘×™×" },
                { value: 3, label: "3 ××—×©×‘×™×" },
                { value: 4, label: "4 ××—×©×‘×™×" },
                { value: 5, label: "5 ××—×©×‘×™×" },
                { value: 6, label: "6 ××—×©×‘×™×" },
                { value: 7, label: "7 ××—×©×‘×™×" },
                { value: 8, label: "8 ××—×©×‘×™×" },
                { value: 9, label: "9 ××—×©×‘×™×" },
                { value: 10, label: "10 ××—×©×‘×™×" },
                { value: 11, label: "11 ××—×©×‘×™×" },
                { value: 12, label: "12 ××—×©×‘×™×" },
                { value: 13, label: "13 ××—×©×‘×™×" },
                { value: 14, label: "14 ××—×©×‘×™×" },
                { value: 15, label: "15 ××—×©×‘×™×" },
                { value: 16, label: "16 ××—×©×‘×™×" },
                { value: 17, label: "17 ××—×©×‘×™×" },
                { value: 18, label: "18 ××—×©×‘×™×" },
                { value: 19, label: "19 ××—×©×‘×™×" },
                { value: 20, label: "20 ××—×©×‘×™×" },
                { value: 21, label: "21 ××—×©×‘×™×" },
                { value: 22, label: "22 ××—×©×‘×™×" },
                { value: 23, label: "23 ××—×©×‘×™×" },
                { value: 24, label: "24 ××—×©×‘×™×" },
                { value: 25, label: "25 ××—×©×‘×™×" },
                { value: 36, label: "×›×œ ×”××—×©×‘×™×" }
            ]
        };

        // Default carts configuration
        const defaultCarts = {
            cart1: {
                name: "×¢×’×œ×” #1",
                computerPrefix: "#1",
                computerCount: 24,
                description: "CHROME BOOKS",
                computers: []
            },
            cart2: {
                name: "×¢×’×œ×” #2",
                computerPrefix: "#2",
                computerCount: 12,
                description: "LENOVO",
                computers: []
            }
        };

        // ==================== ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ====================

        // ×§×‘×œ×ª ×™×•× ×”×©×‘×•×¢ ×‘×¢×‘×¨×™×ª
        function getHebrewDayName(date) {
            const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
            return days[new Date(date).getDay()];
        }

        // ×‘×“×™×§×” ×”×× ×ª××¨×™×š ××ª××™× ×œ×ª×‘× ×™×ª ×”×©××œ×” ×§×‘×•×¢×”
        function isDateMatchingRecurringPattern(checkDate, recurringLoan) {
            const checkDay = new Date(checkDate).getDay();
            const recurringDay = new Date(recurringLoan.loanDate).getDay();
            return checkDay === recurringDay;
        }

        // ×§×‘×œ×ª ×”×©××œ×•×ª ×§×‘×•×¢×•×ª ×©××ª× ×’×©×•×ª ×¢× ×ª××¨×™×š × ×ª×•×Ÿ
        function getConflictingRecurringLoans(date, time) {
            return systemData.recurringLoans.filter(recurring => {
                const isSameDay = isDateMatchingRecurringPattern(date, recurring);
                const isSameTime = recurring.loanTime === time;
                return isSameDay && isSameTime && !recurring.cancelled;
            });
        }

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”×”×©××œ×” ×”×§×‘×•×¢×”
        function updateRecurringLoanStatus() {
            const checkbox = document.getElementById('isRecurringLoan');
            const section = document.getElementById('recurringSection');
            const info = document.getElementById('recurringInfo');
            const warning = document.getElementById('recurringWarning');
            
            if (checkbox.checked) {
                section.classList.add('active');
                info.classList.add('show');
                warning.classList.add('show');
            } else {
                section.classList.remove('active');
                info.classList.remove('show');
                warning.classList.remove('show');
            }
        }

        // Generate Computer List
        function generateComputerList(prefix, count) {
            const computers = [];
            for (let i = 1; i <= count; i++) {
                computers.push(`${prefix}-${i.toString().padStart(3, '0')}`);
            }
            return computers;
        }

        // Initialize Cart Data
        function initializeCartData() {
            const cartData = {};
            
            Object.keys(defaultCarts).forEach(cartId => {
                const cart = defaultCarts[cartId];
                cartData[cartId] = {
                    name: cart.name,
                    description: cart.description || '',
                    computerPrefix: cart.computerPrefix,
                    computerCount: cart.computerCount,
                    computers: generateComputerList(cart.computerPrefix, cart.computerCount)
                };
            });
            
            return cartData;
        }

        // ==================== ×¤×•× ×§×¦×™×•×ª Firebase ====================
        
        // Initialize Firebase
        function initFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    
                    // Listen for connection status
                    const connectedRef = database.ref('.info/connected');
                    connectedRef.on('value', (snapshot) => {
                        isConnected = snapshot.val();
                        updateConnectionStatus(isConnected);
                        
                        if (isConnected) {
                            loadDataFromFirebase();
                            setupFirebaseListeners();
                        }
                    });
                    
                    console.log('âœ… Firebase initialized successfully');
                    return true;
                } else {
                    throw new Error('Firebase SDK not loaded');
                }
            } catch (error) {
                console.error('âŒ Firebase initialization failed:', error);
                updateConnectionStatus(false);
                return false;
            }
        }
        
        // Update Connection Status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = 'ğŸŸ¢ ××—×•×‘×¨×ª ×œ×¢× ×Ÿ';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = 'ğŸ”´ ×× ×•×ª×§×ª';
                statusElement.className = 'connection-status disconnected';
            }
        }
        
        // Load Data from Firebase
        function loadDataFromFirebase() {
            if (!database) return;
            
            database.ref('slaptop').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        
                        // Load configuration
                        if (data.config) {
                            systemData.config = { ...defaultConfig, ...data.config };
                        } else {
                            systemData.config = { ...defaultConfig };
                        }
                        
                        // Load carts
                        if (data.carts) {
                            systemData.carts = data.carts;
                        } else {
                            systemData.carts = initializeCartData();
                        }
                        
                        // Load loans
                        if (data.loans) {
                            systemData.loans = Object.values(data.loans);
                        }
                        
                        // Load recurring loans
                        if (data.recurringLoans) {
                            systemData.recurringLoans = Object.values(data.recurringLoans);
                        }
                        
                        console.log('âœ… Data loaded from Firebase');
                        populateAllSelectors();
                    } else {
                        systemData.config = { ...defaultConfig };
                        systemData.carts = initializeCartData();
                        saveToFirebase();
                    }
                })
                .catch((error) => {
                    console.error('âŒ Error loading data:', error);
                    systemData.config = { ...defaultConfig };
                    systemData.carts = initializeCartData();
                    populateAllSelectors();
                });
        }
        
        // Setup Firebase Listeners
        function setupFirebaseListeners() {
            if (!database) return;
            
            // Listen for config changes
            database.ref('slaptop/config').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    systemData.config = { ...defaultConfig, ...snapshot.val() };
                    populateAllSelectors();
                }
            });
            
            // Listen for cart changes
            database.ref('slaptop/carts').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    systemData.carts = snapshot.val();
                    populateAllSelectors();
                }
            });
            
            // Listen for new loans
            database.ref('slaptop/loans').on('child_added', (snapshot) => {
                const loan = snapshot.val();
                const existingIndex = systemData.loans.findIndex(l => l.id === loan.id);
                if (existingIndex === -1) {
                    systemData.loans.push(loan);
                    console.log('ğŸ“¥ New loan received from Firebase');
                }
            });

            // Listen for loan updates
            database.ref('slaptop/loans').on('child_changed', (snapshot) => {
                const updatedLoan = snapshot.val();
                const existingIndex = systemData.loans.findIndex(l => l.id === updatedLoan.id);
                if (existingIndex !== -1) {
                    systemData.loans[existingIndex] = updatedLoan;
                    console.log('ğŸ“¥ Loan updated from Firebase');
                }
            });

            // Listen for loan deletions
            database.ref('slaptop/loans').on('child_removed', (snapshot) => {
                const deletedLoan = snapshot.val();
                systemData.loans = systemData.loans.filter(l => l.id !== deletedLoan.id);
                console.log('ğŸ“¥ Loan deleted from Firebase');
            });

            // Listen for recurring loan changes
            database.ref('slaptop/recurringLoans').on('child_added', (snapshot) => {
                const recurringLoan = snapshot.val();
                const existingIndex = systemData.recurringLoans.findIndex(l => l.id === recurringLoan.id);
                if (existingIndex === -1) {
                    systemData.recurringLoans.push(recurringLoan);
                    console.log('ğŸ“¥ New recurring loan received from Firebase');
                }
            });

            database.ref('slaptop/recurringLoans').on('child_changed', (snapshot) => {
                const updatedRecurringLoan = snapshot.val();
                const existingIndex = systemData.recurringLoans.findIndex(l => l.id === updatedRecurringLoan.id);
                if (existingIndex !== -1) {
                    systemData.recurringLoans[existingIndex] = updatedRecurringLoan;
                    console.log('ğŸ“¥ Recurring loan updated from Firebase');
                }
            });

            database.ref('slaptop/recurringLoans').on('child_removed', (snapshot) => {
                const deletedRecurringLoan = snapshot.val();
                systemData.recurringLoans = systemData.recurringLoans.filter(l => l.id !== deletedRecurringLoan.id);
                console.log('ğŸ“¥ Recurring loan deleted from Firebase');
            });
        }
        
        // Save to Firebase
        function saveToFirebase() {
            if (!database || !isConnected) {
                console.log('âš ï¸ Firebase not available');
                return;
            }
            
            // Convert arrays to objects for Firebase
            const loansObject = {};
            systemData.loans.forEach(loan => {
                loansObject[loan.id] = loan;
            });

            const recurringLoansObject = {};
            systemData.recurringLoans.forEach(recurringLoan => {
                recurringLoansObject[recurringLoan.id] = recurringLoan;
            });
            
            database.ref('slaptop').set({
			config: systemData.config,
			carts: systemData.carts,
			loans: loansObject,
			recurringLoans: recurringLoansObject
			}).then(() => {
                console.log('âœ… Data saved to Firebase');
            }).catch((error) => {
                console.error('âŒ Error saving data:', error);
            });
        }
        
        // Delete loan from Firebase
        function deleteLoanFromFirebase(loanId) {
            if (!database || !isConnected) {
                console.log('âš ï¸ Firebase not available');
                return Promise.reject('Firebase not available');
            }
            
				return database.ref(`slaptop/loans/${loanId}`).remove()                .then(() => {
                    console.log('âœ… Loan deleted from Firebase');
                    systemData.loans = systemData.loans.filter(l => l.id != loanId);
                })
                .catch((error) => {
                    console.error('âŒ Error deleting loan:', error);
                    throw error;
                });
        }

        // Delete recurring loan from Firebase
        function deleteRecurringLoanFromFirebase(recurringLoanId) {
            if (!database || !isConnected) {
                console.log('âš ï¸ Firebase not available');
                return Promise.reject('Firebase not available');
            }
            
            return database.ref(`slaptop/recurringLoans/${recurringLoanId}`).remove()
                .then(() => {
                    console.log('âœ… Recurring loan deleted from Firebase');
                    systemData.recurringLoans = systemData.recurringLoans.filter(l => l.id != recurringLoanId);
                })
                .catch((error) => {
                    console.error('âŒ Error deleting recurring loan:', error);
                    throw error;
                });
        }

        // ==================== ×¤×•× ×§×¦×™×•×ª ×××©×§ ====================
        
        // Populate All Selectors
        function populateAllSelectors() {
            populateTeacherSelectors();
            populateClassSelectors();
            populateTimeSelectors();
            populateComputerCountSelector();
            populateCartSelectors();
            updateManagementLists();
        }

        // Populate Teacher Selectors
        function populateTeacherSelectors() {
            const teacherSelects = ['teacherName', 'returnTeacher'];
            teacherSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">×‘×—×¨×™ ××•×¨×”...</option>';
                    systemData.config.teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher;
                        option.textContent = teacher;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Populate Class Selectors
        function populateClassSelectors() {
            const classSelects = ['teacherClass', 'teacherClassInput'];
            classSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">×‘×—×¨×™ ×›×™×ª×”...</option>';
                    systemData.config.classes.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        select.appendChild(option);
                    });
                    if (currentValue) select.value = currentValue;
                }
            });
        }

        // Populate Time Selectors
        function populateTimeSelectors() {
            const timeSelects = ['loanTime', 'returnTime', 'expectedReturnTime'];
            timeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">×‘×—×¨×™ ×©×¢×”...</option>';
                    systemData.config.timeSlots.forEach(time => {
                        const option = document.createElement('option');
                        option.value = time;
                        option.textContent = time;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Populate Computer Count Selector
        function populateComputerCountSelector() {
            const computerCountSelect = document.getElementById('computerCount');
            if (computerCountSelect) {
                computerCountSelect.innerHTML = '<option value="">×‘×—×¨×™ ×›××•×ª...</option>';
                systemData.config.computerCountOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.label;
                    computerCountSelect.appendChild(optionElement);
                });
            }
        }

        // Populate Cart Selectors
        function populateCartSelectors() {
            const cartSelects = ['cartSelect', 'cartSelectForComputers'];
            cartSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">×‘×—×¨×™ ×¢×’×œ×”...</option>';
                    Object.keys(systemData.carts).forEach(cartId => {
                        const option = document.createElement('option');
                        option.value = cartId;
                        option.textContent = systemData.carts[cartId].name;
                        select.appendChild(option);
                    });
                    if (currentValue) select.value = currentValue;
                }
            });
        }

        // ==================== ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ ×ª×¦×•×¨×” ====================

        // Switch Management Tab
        function switchManagementTab(tabName) {
            // Update active tab
            document.querySelectorAll('.management-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="switchManagementTab('${tabName}')"]`).classList.add('active');
            
            // Update active content
            document.querySelectorAll('.management-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Content`).classList.add('active');
            
            activeManagementTab = tabName;
            
            // Load specific content
            switch(tabName) {
                case 'overview':
                    updateManagementData();
                    break;
                case 'teachers':
                    updateTeachersList();
                    break;
                case 'times':
                    updateTimesList();
                    break;
                case 'carts':
                    updateCartsList();
                    break;
                case 'computers':
                    updateComputersList();
                    break;
                case 'reports':
                    updateReportsData();
                    break;
            }
        }

        // Update Management Lists
        function updateManagementLists() {
            if (activeManagementTab === 'teachers') updateTeachersList();
            if (activeManagementTab === 'times') updateTimesList();
            if (activeManagementTab === 'carts') updateCartsList();
            if (activeManagementTab === 'computers') updateComputersList();
            if (activeManagementTab === 'reports') updateReportsData();
        }

        // ==================== ×“×•×—×•×ª =============================

        function updateReportsData() {
            updateReportsStats();
            updateRecentReturnNotes();
        }

        function updateReportsStats() {
            const totalReturns = systemData.loans.filter(loan => loan.returned).length;
            const returnsWithNotes = systemData.loans.filter(loan => loan.returned && loan.returnNotes && loan.returnNotes.trim() !== '').length;
            const activeLoansCount = systemData.loans.filter(loan => !loan.returned).length;
            
            document.getElementById('totalReturns').textContent = totalReturns;
            document.getElementById('returnsWithNotes').textContent = returnsWithNotes;
            document.getElementById('activeLoansCount').textContent = activeLoansCount;
        }

        function updateRecentReturnNotes() {
            const container = document.getElementById('recentReturnNotes');
            
            // ×§×‘×œ ×”×—×–×¨×•×ª ×¢× ×”×¢×¨×•×ª, ×××•×™× ×•×ª ×œ×¤×™ ×ª××¨×™×š
            const returnsWithNotes = systemData.loans
                .filter(loan => loan.returned && loan.returnNotes && loan.returnNotes.trim() !== '')
                .sort((a, b) => new Date(b.returnedAt || b.returnDate) - new Date(a.returnedAt || a.returnDate))
                .slice(0, 10); // 10 ×”××—×¨×•× ×•×ª
            
            if (returnsWithNotes.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; font-style: italic;">××™×Ÿ ×”×¢×¨×•×ª ×”×—×–×¨×”</div>';
                return;
            }
            
            let html = '';
            returnsWithNotes.forEach(loan => {
                const returnDate = loan.returnDate || '×œ× ×™×“×•×¢';
                const returnTime = loan.returnTime || '×œ× ×™×“×•×¢';
                
                html += `
                    <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-right: 4px solid #f57c00;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                            ğŸ‘©â€ğŸ« ${loan.teacherName} - ×›×™×ª×” ${loan.teacherClass}
                        </div>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 8px;">
                            ğŸ“… ×”×•×—×–×¨: ${returnDate} ×‘×©×¢×” ${returnTime}
                        </div>
                        <div style="background: #fff8e1; padding: 10px; border-radius: 6px; border-right: 3px solid #ffc107;">
                            <strong>ğŸ’¬ ×”×¢×¨×”:</strong> ${loan.returnNotes}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function exportReturnNotesToExcel() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            
            let filteredLoans = systemData.loans.filter(loan => 
                loan.returned && loan.returnNotes && loan.returnNotes.trim() !== ''
            );
            
            // ×¡× ×Ÿ ×œ×¤×™ ×ª××¨×™×š ×× ×¦×•×™×Ÿ
            if (fromDate) {
                filteredLoans = filteredLoans.filter(loan => loan.returnDate >= fromDate);
            }
            if (toDate) {
                filteredLoans = filteredLoans.filter(loan => loan.returnDate <= toDate);
            }
            
            if (filteredLoans.length === 0) {
                alert('××™×Ÿ ×”×¢×¨×•×ª ×œ×”×¦×’×” ×‘×ª×§×•×¤×” ×©× ×‘×—×¨×”');
                return;
            }
            
            // ××™×™×Ÿ ×œ×¤×™ ×ª××¨×™×š ×”×—×–×¨×”
            filteredLoans.sort((a, b) => new Date(b.returnDate) - new Date(a.returnDate));
            
            // ×‘× ×” CSV
            let csvContent = '\uFEFF'; // BOM for Hebrew support
            csvContent += '×©× ×”××•×¨×”,×›×™×ª×”,×ª××¨×™×š ×”×©××œ×”,×©×¢×ª ×”×©××œ×”,×ª××¨×™×š ×”×—×–×¨×”,×©×¢×ª ×”×—×–×¨×”,××¡×¤×¨ ××—×©×‘×™×,×¢×’×œ×”,××¡×¤×¨×™ ××—×©×‘×™×,×”×¢×¨×•×ª\n';
            
            filteredLoans.forEach(loan => {
                const computerCount = loan.computers ? loan.computers.length : 
                                   (loan.cartSelections ? Object.values(loan.cartSelections).reduce((sum, arr) => sum + arr.length, 0) : 0);
                
                const cartInfo = loan.cart ? systemData.carts[loan.cart]?.name || loan.cart :
                               loan.cartSelections ? Object.keys(loan.cartSelections).map(cartId => systemData.carts[cartId]?.name || cartId).join(' + ') : '×œ× ×™×“×•×¢';
                
                // ×‘× ×” ×¨×©×™××ª ××—×©×‘×™×
                let computersList = '';
                if (loan.computers) {
                    computersList = loan.computers.join(', ');
                } else if (loan.cartSelections) {
                    const computersByCart = Object.entries(loan.cartSelections).map(([cartId, computers]) => {
                        const cartName = systemData.carts[cartId]?.name || cartId;
                        return `${cartName}: ${computers.join(', ')}`;
                    });
                    computersList = computersByCart.join(' | ');
                }
                
                const cleanNotes = loan.returnNotes.replace(/"/g, '""').replace(/\n/g, ' ');
                
                csvContent += `"${loan.teacherName}","${loan.teacherClass}","${loan.loanDate}","${loan.loanTime}","${loan.returnDate}","${loan.returnTime}","${computerCount}","${cartInfo}","${computersList}","${cleanNotes}"\n`;
            });
            
            // ×™×¦×•×¨ ×§×•×‘×¥ ×œ×”×•×¨×“×”
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            const dateRange = fromDate && toDate ? `_${fromDate}_${toDate}` : '';
            link.setAttribute('download', `×”×¢×¨×•×ª_×”×—×–×¨×”${dateRange}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`âœ… ×™×•×¦× ×“×•×— ×”×¢×¨×•×ª ×”×—×–×¨×”: ${filteredLoans.length} ×¨×©×•××•×ª`);
        }

        function exportAllLoansToExcel() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            
            let filteredLoans = [...systemData.loans];
            
            // ×¡× ×Ÿ ×œ×¤×™ ×ª××¨×™×š ×× ×¦×•×™×Ÿ
            if (fromDate) {
                filteredLoans = filteredLoans.filter(loan => loan.loanDate >= fromDate);
            }
            if (toDate) {
                filteredLoans = filteredLoans.filter(loan => loan.loanDate <= toDate);
            }
            
            if (filteredLoans.length === 0) {
                alert('××™×Ÿ ×”×©××œ×•×ª ×œ×”×¦×’×” ×‘×ª×§×•×¤×” ×©× ×‘×—×¨×”');
                return;
            }
            
            // ××™×™×Ÿ ×œ×¤×™ ×ª××¨×™×š ×”×©××œ×”
            filteredLoans.sort((a, b) => new Date(b.loanDate) - new Date(a.loanDate));
            
            // ×‘× ×” CSV
            let csvContent = '\uFEFF'; // BOM for Hebrew support
            csvContent += '×©× ×”××•×¨×”,×›×™×ª×”,×ª××¨×™×š ×”×©××œ×”,×©×¢×ª ×”×©××œ×”,×”×—×–×¨×” ××ª×•×›× × ×ª,×ª××¨×™×š ×”×—×–×¨×”,×©×¢×ª ×”×—×–×¨×”,××¡×¤×¨ ××—×©×‘×™×,×¢×’×œ×”,××¡×¤×¨×™ ××—×©×‘×™×,×¡×˜×˜×•×¡,×”×¢×¨×•×ª ×”×—×–×¨×”,×”×©××œ×” ×§×‘×•×¢×”\n';
            
            filteredLoans.forEach(loan => {
                const computerCount = loan.computers ? loan.computers.length : 
                                   (loan.cartSelections ? Object.values(loan.cartSelections).reduce((sum, arr) => sum + arr.length, 0) : 0);
                
                const cartInfo = loan.cart ? systemData.carts[loan.cart]?.name || loan.cart :
                               loan.cartSelections ? Object.keys(loan.cartSelections).map(cartId => systemData.carts[cartId]?.name || cartId).join(' + ') : '×œ× ×™×“×•×¢';
                
                // ×‘× ×” ×¨×©×™××ª ××—×©×‘×™×
                let computersList = '';
                if (loan.computers) {
                    computersList = loan.computers.join(', ');
                } else if (loan.cartSelections) {
                    const computersByCart = Object.entries(loan.cartSelections).map(([cartId, computers]) => {
                        const cartName = systemData.carts[cartId]?.name || cartId;
                        return `${cartName}: ${computers.join(', ')}`;
                    });
                    computersList = computersByCart.join(' | ');
                }
                
                const status = loan.returned ? '×”×•×—×–×¨' : '×¤×¢×™×œ';
                const returnDate = loan.returnDate || '';
                const returnTime = loan.returnTime || '';
                const expectedReturn = loan.expectedReturnTime || '';
                const notes = loan.returnNotes ? loan.returnNotes.replace(/"/g, '""').replace(/\n/g, ' ') : '';
                const isRecurring = loan.isRecurring ? '×›×Ÿ' : '×œ×';
                
                csvContent += `"${loan.teacherName}","${loan.teacherClass}","${loan.loanDate}","${loan.loanTime}","${expectedReturn}","${returnDate}","${returnTime}","${computerCount}","${cartInfo}","${computersList}","${status}","${notes}","${isRecurring}"\n`;
            });
            
            // ×™×¦×•×¨ ×§×•×‘×¥ ×œ×”×•×¨×“×”
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            const dateRange = fromDate && toDate ? `_${fromDate}_${toDate}` : '';
            link.setAttribute('download', `×›×œ_×”×”×©××œ×•×ª${dateRange}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`âœ… ×™×•×¦× ×“×•×— ×›×œ ×”×”×©××œ×•×ª: ${filteredLoans.length} ×¨×©×•××•×ª`);
        }

        // ==================== × ×™×”×•×œ ××•×¨×•×ª ====================

        function updateTeachersList() {
            const container = document.getElementById('teachersList');
            if (!container) return;
            
            container.innerHTML = '';
            
            systemData.config.teachers.forEach((teacher, index) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="list-item-content">
                        <strong>${teacher}</strong>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-info btn-small" onclick="editTeacher(${index})">âœï¸ ×¢×¨×•×š</button>
                        <button class="btn btn-danger btn-small" onclick="deleteTeacher(${index})">ğŸ—‘ï¸ ××—×§</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function showAddTeacherForm() {
            document.getElementById('teacherForm').style.display = 'block';
            document.getElementById('teacherFormTitle').textContent = '×”×•×¡×¤×ª ××•×¨×” ×—×“×©×”';
            document.getElementById('teacherNameInput').value = '';
            document.getElementById('teacherClassInput').value = '';
            editingItem = null;
        }

        function editTeacher(index) {
            const teacher = systemData.config.teachers[index];
            document.getElementById('teacherForm').style.display = 'block';
            document.getElementById('teacherFormTitle').textContent = '×¢×¨×™×›×ª ××•×¨×”';
            document.getElementById('teacherNameInput').value = teacher;
            document.getElementById('teacherClassInput').value = ''; // We don't store class per teacher
            editingItem = { type: 'teacher', index: index };
        }

        function saveTeacher() {
            const name = document.getElementById('teacherNameInput').value.trim();
            
            if (!name) {
                alert('×× × ×”×›× ×¡ ×©× ××•×¨×”');
                return;
            }
            
            if (editingItem && editingItem.type === 'teacher') {
                // Edit existing teacher
                systemData.config.teachers[editingItem.index] = name;
            } else {
                // Add new teacher
                if (systemData.config.teachers.includes(name)) {
                    alert('××•×¨×” ×–×• ×›×‘×¨ ×§×™×™××ª ×‘××¢×¨×›×ª');
                    return;
                }
                systemData.config.teachers.push(name);
            }
            
            systemData.config.teachers.sort();
            saveToFirebase();
            cancelTeacherForm();
            updateTeachersList();
            populateTeacherSelectors();
        }

        function deleteTeacher(index) {
            const teacher = systemData.config.teachers[index];
            if (confirm(`×”×× ×œ××—×•×§ ××ª ${teacher}?`)) {
                systemData.config.teachers.splice(index, 1);
                saveToFirebase();
                updateTeachersList();
                populateTeacherSelectors();
            }
        }

        function cancelTeacherForm() {
            document.getElementById('teacherForm').style.display = 'none';
            editingItem = null;
        }

        // ==================== × ×™×”×•×œ ×©×¢×•×ª ====================

        function updateTimesList() {
            const container = document.getElementById('timesList');
            if (!container) return;
            
            container.innerHTML = '';
            
            systemData.config.timeSlots.forEach((time, index) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="list-item-content">
                        <strong>${time}</strong>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-info btn-small" onclick="editTime(${index})">âœï¸ ×¢×¨×•×š</button>
                        <button class="btn btn-danger btn-small" onclick="deleteTime(${index})">ğŸ—‘ï¸ ××—×§</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function showAddTimeForm() {
            document.getElementById('timeForm').style.display = 'block';
            document.getElementById('timeFormTitle').textContent = '×”×•×¡×¤×ª ×©×¢×” ×—×“×©×”';
            document.getElementById('timeInput').value = '';
            editingItem = null;
        }

        function editTime(index) {
            const time = systemData.config.timeSlots[index];
            document.getElementById('timeForm').style.display = 'block';
            document.getElementById('timeFormTitle').textContent = '×¢×¨×™×›×ª ×©×¢×”';
            document.getElementById('timeInput').value = time;
            editingItem = { type: 'time', index: index };
        }

        function saveTime() {
            const time = document.getElementById('timeInput').value;
            
            if (!time) {
                alert('×× × ×‘×—×¨ ×©×¢×”');
                return;
            }
            
            if (editingItem && editingItem.type === 'time') {
                // Edit existing time
                systemData.config.timeSlots[editingItem.index] = time;
            } else {
                // Add new time
                if (systemData.config.timeSlots.includes(time)) {
                    alert('×©×¢×” ×–×• ×›×‘×¨ ×§×™×™××ª ×‘××¢×¨×›×ª');
                    return;
                }
                systemData.config.timeSlots.push(time);
            }
            
            systemData.config.timeSlots.sort();
            saveToFirebase();
            cancelTimeForm();
            updateTimesList();
            populateTimeSelectors();
        }

        function deleteTime(index) {
            const time = systemData.config.timeSlots[index];
            if (confirm(`×”×× ×œ××—×•×§ ××ª ×”×©×¢×” ${time}?`)) {
                systemData.config.timeSlots.splice(index, 1);
                saveToFirebase();
                updateTimesList();
                populateTimeSelectors();
            }
        }

        function cancelTimeForm() {
            document.getElementById('timeForm').style.display = 'none';
            editingItem = null;
        }

        // ==================== × ×™×”×•×œ ×¢×’×œ×•×ª ====================

        function updateCartsList() {
            const container = document.getElementById('cartsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.keys(systemData.carts).forEach(cartId => {
                const cart = systemData.carts[cartId];
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="list-item-content">
                        <strong>${cart.name}</strong><br>
                        <small>${cart.description} â€¢ ${cart.computers.length} ××—×©×‘×™× â€¢ ×§×™×“×•××ª: ${cart.computerPrefix}</small>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-info btn-small" onclick="editCart('${cartId}')">âœï¸ ×¢×¨×•×š</button>
                        <button class="btn btn-danger btn-small" onclick="deleteCart('${cartId}')">ğŸ—‘ï¸ ××—×§</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function showAddCartForm() {
            document.getElementById('cartForm').style.display = 'block';
            document.getElementById('cartFormTitle').textContent = '×”×•×¡×¤×ª ×¢×’×œ×” ×—×“×©×”';
            document.getElementById('cartNameInput').value = '';
            document.getElementById('cartDescriptionInput').value = '';
            document.getElementById('cartPrefixInput').value = '';
            document.getElementById('cartCountInput').value = '';
            editingItem = null;
        }

        function editCart(cartId) {
            const cart = systemData.carts[cartId];
            document.getElementById('cartForm').style.display = 'block';
            document.getElementById('cartFormTitle').textContent = '×¢×¨×™×›×ª ×¢×’×œ×”';
            document.getElementById('cartNameInput').value = cart.name;
            document.getElementById('cartDescriptionInput').value = cart.description || '';
            document.getElementById('cartPrefixInput').value = cart.computerPrefix || '';
            document.getElementById('cartCountInput').value = cart.computerCount || cart.computers.length;
            editingItem = { type: 'cart', id: cartId };
        }

        function saveCart() {
            const name = document.getElementById('cartNameInput').value.trim();
            const description = document.getElementById('cartDescriptionInput').value.trim();
            const prefix = document.getElementById('cartPrefixInput').value.trim();
            const count = parseInt(document.getElementById('cartCountInput').value);
            
            if (!name || !prefix || !count) {
                alert('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
                return;
            }
            
            if (count < 1 || count > 50) {
                alert('××¡×¤×¨ ×”××—×©×‘×™× ×—×™×™×‘ ×œ×”×™×•×ª ×‘×™×Ÿ 1 ×œ-50');
                return;
            }
            
            if (editingItem && editingItem.type === 'cart') {
                // Edit existing cart
                const cartId = editingItem.id;
                systemData.carts[cartId].name = name;
                systemData.carts[cartId].description = description;
                systemData.carts[cartId].computerPrefix = prefix;
                systemData.carts[cartId].computerCount = count;
                
                // Regenerate computers if count changed
                if (systemData.carts[cartId].computers.length !== count) {
                    systemData.carts[cartId].computers = generateComputerList(prefix, count);
                }
            } else {
                // Add new cart
                const cartId = 'cart' + Date.now();
                systemData.carts[cartId] = {
                    name: name,
                    description: description,
                    computerPrefix: prefix,
                    computerCount: count,
                    computers: generateComputerList(prefix, count)
                };
            }
            
            saveToFirebase();
            cancelCartForm();
            updateCartsList();
            populateCartSelectors();
        }

        function deleteCart(cartId) {
            const cart = systemData.carts[cartId];
            if (confirm(`×”×× ×œ××—×•×§ ××ª ${cart.name}?\n\n×–×” ×™××—×§ ×’× ××ª ×›×œ ×”××—×©×‘×™× ×©×œ×”.`)) {
                delete systemData.carts[cartId];
                saveToFirebase();
                updateCartsList();
                populateCartSelectors();
            }
        }

        function cancelCartForm() {
            document.getElementById('cartForm').style.display = 'none';
            editingItem = null;
        }

        // ==================== × ×™×”×•×œ ××—×©×‘×™× ====================

        function loadComputersForCart() {
            const cartId = document.getElementById('cartSelectForComputers').value;
            const section = document.getElementById('computerManagementSection');
            
            if (!cartId) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            updateComputersList();
        }

        function updateComputersList() {
            const cartId = document.getElementById('cartSelectForComputers').value;
            const container = document.getElementById('computersList');
            
            if (!cartId || !container) return;
            
            container.innerHTML = '';
            
            const cart = systemData.carts[cartId];
            if (!cart || !cart.computers) return;
            
            cart.computers.forEach((computer, index) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="list-item-content">
                        <strong>${computer}</strong>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-info btn-small" onclick="editComputer('${cartId}', ${index})">âœï¸ ×¢×¨×•×š</button>
                        <button class="btn btn-danger btn-small" onclick="deleteComputer('${cartId}', ${index})">ğŸ—‘ï¸ ××—×§</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function showAddComputerForm() {
            const cartId = document.getElementById('cartSelectForComputers').value;
            if (!cartId) {
                alert('×× × ×‘×—×¨ ×¢×’×œ×” ×§×•×“×');
                return;
            }
            
            document.getElementById('computerForm').style.display = 'block';
            document.getElementById('computerFormTitle').textContent = '×”×•×¡×¤×ª ××—×©×‘ ×—×“×©';
            document.getElementById('computerNameInput').value = '';
            editingItem = null;
        }

        function editComputer(cartId, index) {
            const computer = systemData.carts[cartId].computers[index];
            document.getElementById('computerForm').style.display = 'block';
            document.getElementById('computerFormTitle').textContent = '×¢×¨×™×›×ª ××—×©×‘';
            document.getElementById('computerNameInput').value = computer;
            editingItem = { type: 'computer', cartId: cartId, index: index };
        }

        function saveComputer() {
            const name = document.getElementById('computerNameInput').value.trim();
            const cartId = document.getElementById('cartSelectForComputers').value;
            
            if (!name) {
                alert('×× × ×”×›× ×¡ ×©× ××—×©×‘');
                return;
            }
            
            if (!cartId) {
                alert('×× × ×‘×—×¨ ×¢×’×œ×”');
                return;
            }
            
            if (editingItem && editingItem.type === 'computer') {
                // Edit existing computer
                systemData.carts[cartId].computers[editingItem.index] = name;
            } else {
                // Add new computer
                if (systemData.carts[cartId].computers.includes(name)) {
                    alert('××—×©×‘ ×–×” ×›×‘×¨ ×§×™×™× ×‘×¢×’×œ×”');
                    return;
                }
                systemData.carts[cartId].computers.push(name);
            }
            
            systemData.carts[cartId].computers.sort();
            saveToFirebase();
            cancelComputerForm();
            updateComputersList();
        }

        function deleteComputer(cartId, index) {
            const computer = systemData.carts[cartId].computers[index];
            if (confirm(`×”×× ×œ××—×•×§ ××ª ${computer}?`)) {
                systemData.carts[cartId].computers.splice(index, 1);
                saveToFirebase();
                updateComputersList();
            }
        }

        function regenerateComputers() {
            const cartId = document.getElementById('cartSelectForComputers').value;
            if (!cartId) {
                alert('×× × ×‘×—×¨ ×¢×’×œ×” ×§×•×“×');
                return;
            }
            
            const cart = systemData.carts[cartId];
            if (confirm(`×”×× ×œ×™×¦×•×¨ ××—×“×© ××ª ×¨×©×™××ª ×”××—×©×‘×™× ×¢×‘×•×¨ ${cart.name}?\n\n×–×” ×™××—×§ ××ª ×›×œ ×”××—×©×‘×™× ×”× ×•×›×—×™×™× ×•×™×¦×•×¨ ${cart.computerCount} ××—×©×‘×™× ×—×“×©×™×.`)) {
                cart.computers = generateComputerList(cart.computerPrefix, cart.computerCount);
                saveToFirebase();
                updateComputersList();
            }
        }

        function cancelComputerForm() {
            document.getElementById('computerForm').style.display = 'none';
            editingItem = null;
        }

        // ==================== ×¤×•× ×§×¦×™×•×ª ×”×©××œ×” ====================

        // Show Error Message
        function showError(message) {
            const existingErrors = document.querySelectorAll('.error-message');
            existingErrors.forEach(error => error.remove());
            
            if (!message || message.trim() === '') return;
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                activeScreen.insertBefore(errorDiv, activeScreen.firstChild);
            }
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 4000);
        }

        // Show Screen
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Get Occupied Computers
        function getOccupiedComputers(cartId, date) {
            const occupied = [];

            systemData.loans
                .filter(loan => loan.cart === cartId && loan.loanDate === date && !loan.returned)
                .forEach(loan => {
                    occupied.push(...(loan.computers || []));
                });

            const conflictingRecurring = getConflictingRecurringLoans(date);
            conflictingRecurring.forEach(recurring => {
                if (recurring.cart === cartId) {
                    occupied.push(...(recurring.computers || []));
                } else if (recurring.cartSelections && recurring.cartSelections[cartId]) {
                    occupied.push(...(recurring.cartSelections[cartId] || []));
                }
            });

            return occupied;
        }

        // Get Occupied Computers for Multi-Cart
        function getOccupiedComputersMultiCart(cartId, date, requestedTime = null) {
            const allOccupied = [];
            
            systemData.loans
                .filter(loan => loan.loanDate === date && !loan.returned)
                .forEach(loan => {
                    if (requestedTime && loan.expectedReturnTime) {
                        const timeToMinutes = (timeStr) => {
                            const [hours, minutes] = timeStr.split(':').map(Number);
                            return hours * 60 + minutes;
                        };
                        
                        const requestedMinutes = timeToMinutes(requestedTime);
                        const loanEndMinutes = timeToMinutes(loan.expectedReturnTime);
                        
                        if (requestedMinutes >= loanEndMinutes) {
                            return;
                        }
                    }
                    
                    if (loan.cart === cartId) {
                        allOccupied.push(...(loan.computers || []));
                    } else if (loan.cartSelections && loan.cartSelections[cartId]) {
                        allOccupied.push(...(loan.cartSelections[cartId] || []));
                    }
                });

            if (requestedTime) {
                const conflictingRecurring = getConflictingRecurringLoans(date, requestedTime);
                conflictingRecurring.forEach(recurring => {
                    if (recurring.cart === cartId) {
                        allOccupied.push(...(recurring.computers || []));
                    } else if (recurring.cartSelections && recurring.cartSelections[cartId]) {
                        allOccupied.push(...(recurring.cartSelections[cartId] || []));
                    }
                });
            }
            
            return allOccupied;
        }

        // Get Available Computers Count for Date
        function getAvailableComputersCountForDate(date, requestedTime = null) {
            let totalAvailable = 0;
            Object.keys(systemData.carts).forEach(cartId => {
                const cart = systemData.carts[cartId];
                const occupied = getOccupiedComputersMultiCart(cartId, date, requestedTime);
                totalAvailable += cart.computers.length - occupied.length;
            });
            return totalAvailable;
        }

        // Get Cart Availability for Date
        function getCartAvailabilityForDate(cartId, date, requestedTime = null) {
            const cart = systemData.carts[cartId];
            if (!cart) return 0;
            
            const occupied = getOccupiedComputersMultiCart(cartId, date, requestedTime);
            return cart.computers.length - occupied.length;
        }

        // Get Active Loans for Teacher
        function getActiveLoansForTeacher(teacherName) {
            return systemData.loans.filter(loan => 
                loan.teacherName === teacherName && 
                !loan.returned && 
                loan.type !== 'return'
            );
        }

        // Check if Multi-Cart Mode is Needed
        function checkMultiCartMode() {
            const requiredCount = currentLoan.computerCount || 0;
            const date = currentLoan.loanDate;
            const requestedTime = currentLoan.loanTime;
            
            let hasEnoughInSingleCart = false;
            Object.keys(systemData.carts).forEach(cartId => {
                const available = getCartAvailabilityForDate(cartId, date, requestedTime);
                if (available >= requiredCount) {
                    hasEnoughInSingleCart = true;
                }
            });
            
            const totalAvailable = getAvailableComputersCountForDate(date, requestedTime);
            
            if (!hasEnoughInSingleCart && totalAvailable >= requiredCount) {
                setupMultiCartMode();
                return true;
            } else if (totalAvailable < requiredCount) {
                showError(`×œ× ××¡×¤×™×§ ××—×©×‘×™× ×–××™× ×™× ×‘×ª××¨×™×š ×•×©×¢×” ×–×•. ×–××™× ×™×: ${totalAvailable}, × ×“×¨×©×™×: ${requiredCount}`);
                return false;
            } else {
                setupSingleCartMode();
                return true;
            }
        }

        // Setup Single Cart Mode
        function setupSingleCartMode() {
            isMultiCartMode = false;
            document.getElementById('singleCartSelection').style.display = 'block';
            document.getElementById('multiCartSelection').style.display = 'none';
            
            const cartSelect = document.getElementById('cartSelect');
            cartSelect.innerHTML = '<option value="">×‘×—×¨×™ ×¢×’×œ×”...</option>';
            
            const requiredCount = currentLoan.computerCount || 0;
            const date = currentLoan.loanDate;
            const requestedTime = currentLoan.loanTime;
            
            Object.keys(systemData.carts).forEach(cartId => {
                const available = getCartAvailabilityForDate(cartId, date, requestedTime);
                if (available >= requiredCount) {
                    const option = document.createElement('option');
                    option.value = cartId;
                    option.textContent = `${systemData.carts[cartId].name} (${available} ×–××™× ×™×)`;
                    cartSelect.appendChild(option);
                }
            });
        }

        // Setup Multi-Cart Mode
        function setupMultiCartMode() {
            isMultiCartMode = true;
            selectedCarts = {};
            selectedComputers = [];
            
            document.getElementById('singleCartSelection').style.display = 'none';
            document.getElementById('multiCartSelection').style.display = 'block';
            
            const requiredCount = currentLoan.computerCount || 0;
            document.getElementById('multiRequiredCount').textContent = requiredCount;
            
            setupMultiCartContainer();
        }

        // Setup Multi-Cart Container
        function setupMultiCartContainer() {
            const container = document.getElementById('multiCartContainer');
            container.innerHTML = '';
            
            const date = currentLoan.loanDate;
            const requestedTime = currentLoan.loanTime;
            
            Object.keys(systemData.carts).forEach(cartId => {
                const cart = systemData.carts[cartId];
                const available = getCartAvailabilityForDate(cartId, date, requestedTime);
                
                if (available === 0) return;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-selection-item';
                cartItem.setAttribute('data-cart-id', cartId);
                
                cartItem.innerHTML = `
                    <div class="cart-header">
                        <div class="cart-name">${cart.name}</div>
                        <div class="cart-availability">${available} ×–××™× ×™×</div>
                    </div>
                    <div class="cart-computers-input" id="computers-${cartId}">
                        <label>×‘×—×¨ ××—×©×‘×™× ××¢×’×œ×” ×–×•:</label>
                        <div class="computer-grid" id="grid-${cartId}"></div>
                    </div>
                `;
                
                cartItem.addEventListener('click', (e) => {
                    if (e.target.closest('.computer-grid') || e.target.closest('.computer-label')) {
                        return;
                    }
                    toggleCartSelection(cartId, cartItem);
                });
                
                container.appendChild(cartItem);
            });
        }

        // Toggle Cart Selection
        function toggleCartSelection(cartId, element) {
            const computersInput = element.querySelector('.cart-computers-input');
            const isCurrentlySelected = element.classList.contains('selected');
            
            if (isCurrentlySelected) {
                element.classList.remove('selected');
                computersInput.classList.remove('show');
                delete selectedCarts[cartId];
                
                selectedComputers = selectedComputers.filter(comp => !comp.startsWith(systemData.carts[cartId].computers[0].split('-')[0]));
            } else {
                element.classList.add('selected');
                computersInput.classList.add('show');
                selectedCarts[cartId] = [];
                setupCartComputerGrid(cartId);
            }
            
            updateMultiComputerCount();
            updateSubmitButton();
        }

        // Setup Cart Computer Grid
        function setupCartComputerGrid(cartId) {
            const grid = document.getElementById(`grid-${cartId}`);
            grid.innerHTML = '';
            
            const cart = systemData.carts[cartId];
            const occupiedComputers = getOccupiedComputersMultiCart(cartId, currentLoan.loanDate, currentLoan.loanTime);
            
            cart.computers.forEach(computer => {
                const isOccupied = occupiedComputers.includes(computer);
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `multi-${computer}`;
                checkbox.className = 'computer-checkbox';
                checkbox.value = computer;
                checkbox.disabled = isOccupied;
                checkbox.setAttribute('data-cart', cartId);
                
                const label = document.createElement('label');
                label.htmlFor = `multi-${computer}`;
                label.className = 'computer-label';
                label.textContent = computer;
                
                grid.appendChild(checkbox);
                grid.appendChild(label);
                
                checkbox.addEventListener('change', () => updateMultiCartComputerSelection(cartId, computer, checkbox.checked));
            });
        }

        // Update Multi-Cart Computer Selection
        function updateMultiCartComputerSelection(cartId, computer, isSelected) {
            if (isSelected) {
                if (!selectedCarts[cartId].includes(computer)) {
                    selectedCarts[cartId].push(computer);
                    selectedComputers.push(computer);
                }
            } else {
                selectedCarts[cartId] = selectedCarts[cartId].filter(c => c !== computer);
                selectedComputers = selectedComputers.filter(c => c !== computer);
            }
            
            updateMultiComputerCount();
            updateSubmitButton();
        }

        // Update Multi Computer Count
        function updateMultiComputerCount() {
            const selectedCount = selectedComputers.length;
            const requiredCount = currentLoan.computerCount || 0;
            
            const countInfo = document.getElementById('multiComputerCountInfo');
            if (countInfo) {
                countInfo.innerHTML = `× ×‘×—×¨×•: ${selectedCount} ××ª×•×š <span id="multiRequiredCount">${requiredCount}</span>`;
            }
        }
        
        // Update Available Computers (Single Cart Mode)
        function updateAvailableComputers() {
            const selectedCart = document.getElementById('cartSelect').value;
            const computerSection = document.getElementById('computerSection');
            const computerGrid = document.getElementById('computerGrid');
            
            if (!selectedCart) {
                computerSection.style.display = 'none';
                return;
            }
            
            computerSection.style.display = 'block';
            computerGrid.innerHTML = '';
            selectedComputers = [];
            
            const cartData = systemData.carts[selectedCart];
            const occupiedComputers = getOccupiedComputersMultiCart(selectedCart, currentLoan.loanDate, currentLoan.loanTime);
            
            if (cartData && cartData.computers) {
                cartData.computers.forEach(computer => {
                    const isOccupied = occupiedComputers.includes(computer);
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = computer;
                    checkbox.className = 'computer-checkbox';
                    checkbox.value = computer;
                    checkbox.disabled = isOccupied;
                    
                    const label = document.createElement('label');
                    label.htmlFor = computer;
                    label.className = 'computer-label';
                    label.textContent = computer;
                    
                    computerGrid.appendChild(checkbox);
                    computerGrid.appendChild(label);
                    
                    checkbox.addEventListener('change', updateSelectedComputers);
                });
            }
            
            updateSelectedCount();
        }
        
        // Update Selected Computers (Single Cart Mode)
        function updateSelectedComputers() {
            const checkboxes = document.querySelectorAll('#computerGrid .computer-checkbox:checked');
            selectedComputers = Array.from(checkboxes).map(cb => cb.value);
            updateSelectedCount();
            updateSubmitButton();
        }
        
        // Update Selected Count (Single Cart Mode)
        function updateSelectedCount() {
            const selectedCount = selectedComputers.length;
            const requiredCount = currentLoan.computerCount || 0;
            
            const countInfo = document.getElementById('computerCountInfo');
            if (countInfo) {
                countInfo.innerHTML = `× ×‘×—×¨×•: ${selectedCount} ××ª×•×š <span id="requiredCount">${requiredCount}</span>`;
            }
        }
        
        // Update Submit Button
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitLoan');
            if (!submitBtn) return;
            
            const selectedCount = selectedComputers.length;
            const requiredCount = currentLoan.computerCount || 0;
            
            submitBtn.disabled = selectedCount !== requiredCount;
            
            if (selectedCount === requiredCount && selectedCount > 0) {
                submitBtn.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
                submitBtn.textContent = '×©×œ×— ×”×©××œ×”';
            } else {
                submitBtn.style.background = '#ccc';
                submitBtn.textContent = `×‘×—×¨ ${requiredCount - selectedCount} ××—×©×‘×™× × ×•×¡×¤×™×`;
            }
        }

        // Load Active Loans for Return
        function loadActiveLoansForReturn(teacherName) {
            const activeLoans = getActiveLoansForTeacher(teacherName);
            const loansList = document.getElementById('activeLoansList');
            
            if (activeLoans.length === 0) {
                loansList.innerHTML = '<div class="no-loans">××™×Ÿ ×”×©××œ×•×ª ×¤×¢×™×œ×•×ª ×œ××•×¨×” ×–×•</div>';
                return;
            }
            
            loansList.innerHTML = '';
            
            activeLoans.forEach(loan => {
                const loanItem = document.createElement('div');
                loanItem.className = 'loan-item';
                loanItem.setAttribute('data-loan-id', loan.id);
                
                const loanHeader = document.createElement('div');
                loanHeader.className = 'loan-header';
                loanHeader.textContent = `×”×©××œ×” ××ª××¨×™×š ${loan.loanDate} - ${loan.loanTime}`;
                
                const computerCount = loan.computers ? loan.computers.length : 
                                   (loan.cartSelections ? Object.values(loan.cartSelections).reduce((sum, arr) => sum + arr.length, 0) : 0);
                
                const cartInfo = loan.cart ? systemData.carts[loan.cart]?.name || loan.cart :
                               loan.cartSelections ? Object.keys(loan.cartSelections).map(cartId => systemData.carts[cartId]?.name || cartId).join(', ') : '×œ× ×™×“×•×¢';
                
                const loanDetails = document.createElement('div');
                loanDetails.className = 'loan-details';
                loanDetails.textContent = `×›×™×ª×” ${loan.teacherClass} â€¢ ${computerCount} ××—×©×‘×™× â€¢ ${cartInfo}`;
                
                loanItem.appendChild(loanHeader);
                loanItem.appendChild(loanDetails);
                
                loanItem.addEventListener('click', () => selectLoanForReturn(loan, loanItem));
                
                loansList.appendChild(loanItem);
            });
        }

        // Select Loan for Return
        function selectLoanForReturn(loan, element) {
            document.querySelectorAll('.loan-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedLoanForReturn = loan;
            
            document.getElementById('returnDetailsSection').style.display = 'block';
            document.getElementById('returnTimeSection').style.display = 'block';
            document.getElementById('returnNotesSection').style.display = 'block';
            
            updateReturnSubmitButton();
        }

        // Update Return Submit Button
        function updateReturnSubmitButton() {
            const submitBtn = document.getElementById('submitReturn');
            const returnDate = document.getElementById('returnDate').value;
            const returnTime = document.getElementById('returnTime').value;
            
            submitBtn.disabled = !selectedLoanForReturn || !returnDate || !returnTime;
        }
        
        // Cancel Future Loan
        function cancelFutureLoan(loanId) {
            const loan = systemData.loans.find(loan => loan.id == loanId);
            
            if (!loan) {
                alert('âŒ ×”×©××œ×” ×œ× × ××¦××”!');
                return;
            }
            
            const currentDate = new Date().toISOString().split('T')[0];
            if (loan.loanDate <= currentDate) {
                alert('âŒ × ×™×ª×Ÿ ×œ×‘×˜×œ ×¨×§ ×”×©××œ×•×ª ×¢×ª×™×“×™×•×ª!');
                return;
            }
            
            const computerCount = loan.computers ? loan.computers.length : 
                               (loan.cartSelections ? Object.values(loan.cartSelections).reduce((sum, arr) => sum + arr.length, 0) : 0);
            
            const confirm = window.confirm(`âš ï¸ ×”×× ×œ×‘×˜×œ ××ª ×”×”×©××œ×” ×©×œ ${loan.teacherName}?\n\n×¤×¨×˜×™ ×”×”×©××œ×”:\nğŸ“… ×ª××¨×™×š: ${loan.loanDate}\nâ° ×©×¢×”: ${loan.loanTime}\nğŸ–¥ï¸ ××—×©×‘×™×: ${computerCount}\n\n×”×”×©××œ×” ×ª×™××—×§ ×œ×—×œ×•×˜×™×Ÿ ××”××¢×¨×›×ª.`);
            
            if (!confirm) return;
            
            try {
                deleteLoanFromFirebase(loanId)
                    .then(() => {
                        updateManagementData();
                        alert(`âœ… ×‘×•×˜×œ×” ×‘×”×¦×œ×—×”!\n\n×”×”×©××œ×” ×©×œ ${loan.teacherName} ×‘×•×˜×œ×”.\n${computerCount} ××—×©×‘×™× ×©×•×—×¨×¨×•.`);
                        console.log(`âœ… ×‘×•×˜×œ×” ×”×©××œ×”: ${loan.teacherName} - ${computerCount} ××—×©×‘×™×`);
                    })
                    .catch((error) => {
                        console.error('âŒ ×©×’×™××” ×‘×‘×™×˜×•×œ ×”×”×©××œ×”:', error);
                        alert('âŒ ×©×’×™××” ×‘×‘×™×˜×•×œ ×”×”×©××œ×”. × ×¡×” ×©×•×‘.');
                    });
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×‘×™×˜×•×œ ×”×©××œ×”:', error);
                alert('âŒ ×©×’×™××” ×‘×‘×™×˜×•×œ ×”×”×©××œ×”. × ×¡×” ×©×•×‘.');
            }
        }

        // Cancel Recurring Loan
        function cancelRecurringLoan(recurringLoanId) {
            const recurringLoan = systemData.recurringLoans.find(loan => loan.id == recurringLoanId);
            
            if (!recurringLoan) {
                alert('âŒ ×”×©××œ×” ×§×‘×•×¢×” ×œ× × ××¦××”!');
                return;
            }
            
            const computerCount = recurringLoan.computers ? recurringLoan.computers.length : 
                               (recurringLoan.cartSelections ? Object.values(recurringLoan.cartSelections).reduce((sum, arr) => sum + arr.length, 0) : 0);
            
            const dayName = getHebrewDayName(recurringLoan.loanDate);
            
            const confirm = window.confirm(`âš ï¸ ×”×× ×œ×‘×˜×œ ××ª ×”×”×©××œ×” ×”×§×‘×•×¢×” ×©×œ ${recurringLoan.teacherName}?\n\nğŸ“‹ ×¤×¨×˜×™ ×”×”×©××œ×”:\nğŸ“… ×›×œ ×™×•× ${dayName}\nâ° ×©×¢×”: ${recurringLoan.loanTime}\nğŸ–¥ï¸ ××—×©×‘×™×: ${computerCount}\n\nâš ï¸ ×–×” ×™×‘×˜×œ ××ª ×”×”×©××œ×” ×”×§×‘×•×¢×” ×œ×›×œ ×”×©×‘×•×¢×•×ª ×”×‘××™×!`);
            
            if (!confirm) return;
            
            try {
                deleteRecurringLoanFromFirebase(recurringLoanId)
                    .then(() => {
                        updateManagementData();
                        alert(`âœ… ×”×©××œ×” ×§×‘×•×¢×” ×‘×•×˜×œ×”!\n\n×”×”×©××œ×” ×”×§×‘×•×¢×” ×©×œ ${recurringLoan.teacherName} ×‘×•×˜×œ×”.\n${computerCount} ××—×©×‘×™× ×©×•×—×¨×¨×• ×‘×›×œ ×™×•× ${dayName}.`);
                        console.log(`âœ… ×‘×•×˜×œ×” ×”×©××œ×” ×§×‘×•×¢×”: ${recurringLoan.teacherName} - ${dayName}`);
                    })
                    .catch((error) => {
                        console.error('âŒ ×©×’×™××” ×‘×‘×™×˜×•×œ ×”×”×©××œ×” ×”×§×‘×•×¢×”:', error);
                        alert('âŒ ×©×’×™××” ×‘×‘×™×˜×•×œ ×”×”×©××œ×” ×”×§×‘×•×¢×”. × ×¡×” ×©×•×‘.');
                    });
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×‘×™×˜×•×œ ×”×©××œ×” ×§×‘×•×¢×”:', error);
                alert('âŒ ×©×’×™××” ×‘×‘×™×˜×•×œ ×”×”×©××œ×” ×”×§×‘×•×¢×”. × ×¡×” ×©×•×‘.');
            }
        }
        
        // Management Functions
        function showPasswordScreen() {
            document.getElementById('adminPassword').value = '';
            showScreen('passwordScreen');
        }
        
        function checkPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === 's0987') {
                showManagementScreen();
            } else {
                showError('×¡×™×¡××” ×©×’×•×™×”! × ×¡×™ ×©×•×‘.');
                document.getElementById('adminPassword').value = '';
            }
        }
        
        function showManagementScreen() {
            switchManagementTab('overview');
            showScreen('managementScreen');
        }
        
        function updateManagementData() {
            updateGeneralStats();
            updateCurrentLoans();
            updateRecurringLoans();
            updateFutureLoans();
            updateCartStatus();
        }
        
        function updateGeneralStats() {
            const totalComputers = Object.values(systemData.carts).reduce((sum, cart) => sum + cart.computers.length, 0);
            const currentDate = new Date().toISOString().split('T')[0];
            
            const loanedToday = systemData.loans.filter(loan => 
                loan.loanDate <= currentDate && !loan.returned
            );
            
            let loanedComputersCount = 0;
            loanedToday.forEach(loan => {
                if (loan.computers) {
                    loanedComputersCount += loan.computers.length;
                } else if (loan.cartSelections) {
                    loanedComputersCount += Object.values(loan.cartSelections).reduce((sum, arr) => sum + arr.length, 0);
                }
            });
            
            const availableComputers = totalComputers - loanedComputersCount;
            
            document.getElementById('totalComputers').textContent = totalComputers;
            document.getElementById('loanedComputers').textContent = loanedComputersCount;
            document.getElementById('availableComputers').textContent = availableComputers;
        }
        
        function updateCurrentLoans() {
            const currentDate = new Date().toISOString().split('T')[0];
            const currentLoans = systemData.loans.filter(loan => 
                loan.loanDate <= currentDate && !loan.returned && loan.type !== 'return'
            );
            
            const container = document.getElementById('currentLoans');
            
            if (currentLoans.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; font-style: italic;">××™×Ÿ ×”×©××œ×•×ª ×¤×¢×™×œ×•×ª ×›×¨×’×¢</div>';
                return;
            }
            
            let html = '';
            currentLoans.forEach(loan => {
                const computerCount = loan.computers ? loan.computers.length : 
                                   (loan.cartSelections ? Object.values(loan.cartSelections).reduce((sum, arr) => sum + arr.length, 0) : 0);
                
                const cartInfo = loan.cart ? systemData.carts[loan.cart]?.name || loan.cart :
                               loan.cartSelections ? Object.keys(loan.cartSelections).map(cartId => systemData.carts[cartId]?.name || cartId).join(', ') : '×œ× ×™×“×•×¢';
                
                const computerDetails = loan.computers ? 
                    `××—×©×‘×™×: ${loan.computers.slice(0, 5).join(', ')}${loan.computers.length > 5 ? ` ×•-${loan.computers.length - 5} × ×•×¡×¤×™×...` : ''}` :
                    loan.cartSelections ? 
                    `××—×©×‘×™× ××›××” ×¢×’×œ×•×ª: ${Object.entries(loan.cartSelections).map(([cartId, computers]) => 
                        `${systemData.carts[cartId]?.name || cartId} (${computers.length})`).join(', ')}` : '';
                
                html += `
                    <div class="loan-management-item current">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333;">ğŸ‘©â€ğŸ« ${loan.teacherName} - ×›×™×ª×” ${loan.teacherClass}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ğŸ“… ${loan.loanDate} â€¢ â° ${loan.loanTime} â€¢ ğŸ–¥ï¸ ${computerCount} ××—×©×‘×™× â€¢ ğŸ›’ ${cartInfo}
                            </div>
                            ${computerDetails ? `
                                <div style="font-size: 0.8em; color: #999; margin-top: 5px;">
                                    ${computerDetails}
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="returnSpecificLoan('${loan.id}')" class="btn-danger">
                            âœ… ×”×—×–×¨
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateRecurringLoans() {
            const container = document.getElementById('recurringLoans');
            
            if (systemData.recurringLoans.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; font-style: italic;">××™×Ÿ ×”×©××œ×•×ª ×§×‘×•×¢×•×ª</div>';
                return;
            }
            
            let html = '';
            systemData.recurringLoans.filter(loan => !loan.cancelled).forEach(recurringLoan => {
                const computerCount = recurringLoan.computers ? recurringLoan.computers.length : 
                                   (recurringLoan.cartSelections ? Object.values(recurringLoan.cartSelections).reduce((sum, arr) => sum + arr.length, 0) : 0);
                
                const cartInfo = recurringLoan.cart ? systemData.carts[recurringLoan.cart]?.name || recurringLoan.cart :
                               recurringLoan.cartSelections ? Object.keys(recurringLoan.cartSelections).map(cartId => systemData.carts[cartId]?.name || cartId).join(', ') : '×œ× ×™×“×•×¢';
                
                const dayName = getHebrewDayName(recurringLoan.loanDate);
                
                const computerDetails = recurringLoan.computers ? 
                    `××—×©×‘×™×: ${recurringLoan.computers.slice(0, 5).join(', ')}${recurringLoan.computers.length > 5 ? ` ×•-${recurringLoan.computers.length - 5} × ×•×¡×¤×™×...` : ''}` :
                    recurringLoan.cartSelections ? 
                    `××—×©×‘×™× ××›××” ×¢×’×œ×•×ª: ${Object.entries(recurringLoan.cartSelections).map(([cartId, computers]) => 
                        `${systemData.carts[cartId]?.name || cartId} (${computers.length})`).join(', ')}` : '';
                
                html += `
                    <div class="loan-management-item recurring">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333;">ğŸ‘©â€ğŸ« ${recurringLoan.teacherName} - ×›×™×ª×” ${recurringLoan.teacherClass}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ğŸ”„ ×›×œ ×™×•× ${dayName} â€¢ â° ${recurringLoan.loanTime} â€¢ ğŸ–¥ï¸ ${computerCount} ××—×©×‘×™× â€¢ ğŸ›’ ${cartInfo}
                            </div>
                            ${computerDetails ? `
                                <div style="font-size: 0.8em; color: #999; margin-top: 5px;">
                                    ${computerDetails}
                                </div>
                            ` : ''}
                            <div style="font-size: 0.8em; color: #7b1fa2; margin-top: 5px; font-weight: bold;">
                                ğŸ”„ ×”×©××œ×” ×§×‘×•×¢×” - ×—×•×–×¨×ª ×›×œ ×©×‘×•×¢
                            </div>
                        </div>
                        <button onclick="cancelRecurringLoan('${recurringLoan.id}')" class="btn-danger">
                            âŒ ×‘×˜×œ ×§×‘×•×¢×”
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function updateFutureLoans() {
            const currentDate = new Date().toISOString().split('T')[0];
            const futureLoans = systemData.loans.filter(loan => 
                loan.loanDate > currentDate && loan.type !== 'return'
            ).sort((a, b) => new Date(a.loanDate) - new Date(b.loanDate));
            
            const container = document.getElementById('futureLoans');
            
            if (futureLoans.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; font-style: italic;">××™×Ÿ ×”×©××œ×•×ª ××ª×•×›× × ×•×ª</div>';
                return;
            }
            
            let html = '';
            futureLoans.forEach(loan => {
                const computerCount = loan.computers ? loan.computers.length : 
                                   (loan.cartSelections ? Object.values(loan.cartSelections).reduce((sum, arr) => sum + arr.length, 0) : loan.computerCount || 0);
                
                const cartInfo = loan.cart ? systemData.carts[loan.cart]?.name || loan.cart :
                               loan.cartSelections ? Object.keys(loan.cartSelections).map(cartId => systemData.carts[cartId]?.name || cartId).join(', ') : '×œ× ×™×“×•×¢';
                
                const loanDate = new Date(loan.loanDate);
                const today = new Date();
                const daysUntil = Math.ceil((loanDate - today) / (1000 * 60 * 60 * 24));
                
                html += `
                    <div class="loan-management-item future">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333;">ğŸ‘©â€ğŸ« ${loan.teacherName} - ×›×™×ª×” ${loan.teacherClass}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ğŸ“… ${loan.loanDate} (×‘×¢×•×“ ${daysUntil} ×™××™×) â€¢ â° ${loan.loanTime} â€¢ ğŸ–¥ï¸ ${computerCount} ××—×©×‘×™× â€¢ ğŸ›’ ${cartInfo}
                            </div>
                        </div>
                        <button onclick="cancelFutureLoan('${loan.id}')" class="btn-danger">
                            âŒ ×‘×˜×œ
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function updateCartStatus() {
            const container = document.getElementById('cartStatus');
            const currentDate = new Date().toISOString().split('T')[0];
            
            let html = '';
            Object.keys(systemData.carts).forEach(cartId => {
                const cart = systemData.carts[cartId];
                
                let loanedComputers = 0;
                systemData.loans.filter(loan => loan.loanDate <= currentDate && !loan.returned).forEach(loan => {
                    if (loan.cart === cartId) {
                        loanedComputers += loan.computers ? loan.computers.length : 0;
                    } else if (loan.cartSelections && loan.cartSelections[cartId]) {
                        loanedComputers += loan.cartSelections[cartId].length;
                    }
                });
                
                const availableComputers = cart.computers.length - loanedComputers;
                const usagePercentage = Math.round((loanedComputers / cart.computers.length) * 100);
                
                const cartLoans = systemData.loans.filter(loan => 
                    loan.loanDate <= currentDate && !loan.returned && 
                    (loan.cart === cartId || (loan.cartSelections && loan.cartSelections[cartId]))
                );
                
                html += `
                    <div style="background: white; padding: 12px; margin: 8px 0; border-radius: 5px; border-right: 4px solid #9c27b0;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 8px;">ğŸ›’ ${cart.name}</div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                            <div>ğŸ“¦ ×¡×”"×›: ${cart.computers.length}</div>
                            <div style="color: #f44336;">ğŸ”„ ××•×©××œ×™×: ${loanedComputers}</div>
                            <div style="color: #4caf50;">âœ… ×–××™× ×™×: ${availableComputers}</div>
                        </div>
                        <div style="background: #f5f5f5; height: 8px; border-radius: 4px; margin-top: 8px; overflow: hidden;">
                            <div style="background: ${usagePercentage > 80 ? '#f44336' : usagePercentage > 50 ? '#ff9800' : '#4caf50'}; height: 100%; width: ${usagePercentage}%; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 4px;">${usagePercentage}% ×‘×©×™××•×©</div>
                        
                        ${cartLoans.length > 0 ? `
                            <div style="margin-top: 10px; font-size: 0.8em;">
                                <strong>××•×©××œ ×›×¨×’×¢ ×œ:</strong>
                                ${cartLoans.map(loan => {
                                    const computerCount = loan.cart === cartId ? 
                                        (loan.computers ? loan.computers.length : 0) :
                                        (loan.cartSelections && loan.cartSelections[cartId] ? loan.cartSelections[cartId].length : 0);
                                    return `<div style="color: #666;">â€¢ ${loan.teacherName} (${computerCount} ××—×©×‘×™×)</div>`;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function returnSpecificLoan(loanId) {
            const loanIndex = systemData.loans.findIndex(loan => loan.id == loanId);
            
            if (loanIndex === -1) {
                alert('âŒ ×”×©××œ×” ×œ× × ××¦××”!');
                return;
            }
            
            const loan = systemData.loans[loanIndex];
            
            const computerCount = loan.computers ? loan.computers.length : 
                               (loan.cartSelections ? Object.values(loan.cartSelections).reduce((sum, arr) => sum + arr.length, 0) : 0);
            
            const confirm = window.confirm(`âš ï¸ ×”×× ×œ×¡××Ÿ ××ª ×”×”×©××œ×” ×©×œ ${loan.teacherName} ×›×”×•×—×–×¨×”?\n\n${computerCount} ××—×©×‘×™× ×™×©×•×—×¨×¨×•.`);
            
            if (!confirm) return;
            
            try {
                const currentDate = new Date().toISOString().split('T')[0];
                const currentTime = new Date().toTimeString().split(' ')[0].substring(0, 5);
                
                systemData.loans[loanIndex].returned = true;
                systemData.loans[loanIndex].returnDate = currentDate;
                systemData.loans[loanIndex].returnTime = currentTime;
                systemData.loans[loanIndex].returnNotes = '×”×—×–×¨×” ×××¡×š × ×™×”×•×œ';
                systemData.loans[loanIndex].returnedAt = new Date().toISOString();
                
                saveToFirebase();
                updateManagementData();
                
                alert(`âœ… ×”×•×©×œ×!\n\n×”×”×©××œ×” ×©×œ ${loan.teacherName} ×¡×•×× ×” ×›×”×•×—×–×¨×”.\n${computerCount} ××—×©×‘×™× ×©×•×—×¨×¨×•.`);
                console.log(`âœ… ×”×•×—×–×¨×” ×”×©××œ×”: ${loan.teacherName} - ${computerCount} ××—×©×‘×™×`);
                
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×”×—×–×¨×ª ×”×©××œ×”:', error);
                alert('âŒ ×©×’×™××” ×‘×”×—×–×¨×ª ×”×”×©××œ×”. × ×¡×” ×©×•×‘.');
            }
        }
        
        // Navigation Functions
        function goToDateScreen() {
            const teacherName = document.getElementById('teacherName').value;
            const teacherClass = document.getElementById('teacherClass').value;
            
            if (!teacherName || !teacherClass) {
                showError('×× × ×‘×—×¨ ××•×¨×” ×•×›×™×ª×”');
                return;
            }
            
            currentLoan.teacherName = teacherName;
            currentLoan.teacherClass = teacherClass;
            
            showScreen('dateScreen');
        }
        
        function goToComputerScreen() {
            const loanDate = document.getElementById('loanDate').value;
            const loanTime = document.getElementById('loanTime').value;
            const computerCount = document.getElementById('computerCount').value;
            const expectedReturnTime = document.getElementById('expectedReturnTime').value;
            const isRecurring = document.getElementById('isRecurringLoan').checked;
            
            if (!loanDate || !loanTime || !computerCount || !expectedReturnTime) {
                showError('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }

            if (isRecurring) {
                const dayName = getHebrewDayName(loanDate);
                const conflictingRecurring = getConflictingRecurringLoans(loanDate, loanTime);
                
                if (conflictingRecurring.length > 0) {
                    const conflictNames = conflictingRecurring.map(r => r.teacherName).join(', ');
                    showError(`âš ï¸ ×›×‘×¨ ×§×™×™××ª ×”×©××œ×” ×§×‘×•×¢×” ×‘×™×•× ${dayName} ×‘×©×¢×” ${loanTime} ×¢×‘×•×¨: ${conflictNames}`);
                    return;
                }
                
                const confirm = window.confirm(`ğŸ”„ ×”×©××œ×” ×§×‘×•×¢×” - ××™×©×•×¨\n\n××ª ×¢×•××“×ª ×œ×™×¦×•×¨ ×”×©××œ×” ×§×‘×•×¢×” ×¢×‘×•×¨ ${currentLoan.teacherName}:\nğŸ“… ×›×œ ×™×•× ${dayName}\nâ° ×©×¢×” ${loanTime}\nğŸ–¥ï¸ ${computerCount} ××—×©×‘×™×\n\n×”××—×©×‘×™× ×™×”×™×• ×ª×¤×•×¡×™× ×‘×›×œ ×©×‘×•×¢!\n\n×”×× ×œ×”××©×™×š?`);
                
                if (!confirm) {
                    return;
                }
            }
            
            currentLoan.loanDate = loanDate;
            currentLoan.loanTime = loanTime;
            currentLoan.computerCount = parseInt(computerCount);
            currentLoan.expectedReturnTime = expectedReturnTime;
            currentLoan.isRecurring = isRecurring;
            
            selectedComputers = [];
            selectedCarts = {};
            
            if (checkMultiCartMode()) {
                showScreen('computerScreen');
            }
        }

        function goToReturnLoanSelect() {
            const teacherName = document.getElementById('returnTeacher').value;
            
            if (!teacherName) {
                showError('×× × ×‘×—×¨ ××•×¨×”');
                return;
            }
            
            document.getElementById('selectedTeacherName').textContent = teacherName;
            loadActiveLoansForReturn(teacherName);
            showScreen('returnLoanSelectScreen');
        }
        
        // Submit Loan
        function submitLoan() {
            if (isMultiCartMode) {
                submitMultiCartLoan();
            } else {
                submitSingleCartLoan();
            }
        }

        // Submit Single Cart Loan
        function submitSingleCartLoan() {
            const selectedCart = document.getElementById('cartSelect').value;
            
            if (!selectedCart || selectedComputers.length !== currentLoan.computerCount) {
                showError('×× × ×‘×—×¨ ×¢×’×œ×” ×•××¡×¤×¨ ×”××—×©×‘×™× ×”× ×“×¨×©');
                return;
            }
            
            const baseLoan = {
                id: Date.now(),
                ...currentLoan,
                cart: selectedCart,
                computers: [...selectedComputers],
                returned: false,
                createdAt: new Date().toISOString()
            };

            if (currentLoan.isRecurring) {
                const recurringLoan = {
                    ...baseLoan,
                    type: 'recurring',
                    dayOfWeek: new Date(currentLoan.loanDate).getDay()
                };
                
                systemData.recurringLoans.push(recurringLoan);
                systemData.loans.push(baseLoan);
                
                document.getElementById('successTitle').textContent = '×”×©××œ×” ×§×‘×•×¢×” × ×•×¦×¨×”!';
                document.getElementById('successMessage').textContent = `×”××—×©×‘×™× ×”×•×§×¦×• ×‘×”×¦×œ×—×” ×œ××•×¨×”.\nğŸ”„ ×”×©××œ×” ×ª×—×–×•×¨ ×›×œ ×©×‘×•×¢ ×‘××•×ª×• ×™×•× ×•×©×¢×”.`;
            } else {
                systemData.loans.push(baseLoan);
                
                const returnTimeMsg = currentLoan.expectedReturnTime ? 
                    `\n×”×—×–×¨×” ××ª×•×›× × ×ª: ×”×™×•× ×‘×©×¢×” ${currentLoan.expectedReturnTime}` : '';
                
                document.getElementById('successTitle').textContent = '×”×©××œ×” ××•×©×¨×”!';
                document.getElementById('successMessage').textContent = `×”××—×©×‘×™× ×”×•×§×¦×• ×‘×”×¦×œ×—×” ×œ××•×¨×”.${returnTimeMsg}`;
            }
            
            saveToFirebase();
            showScreen('successScreen');
            
            // ×¨×¢× ×•×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ ××—×¨×™ ×”×©××œ×”
            setTimeout(() => {
                console.log('ğŸ”„ ××¨×¢× ×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ ××—×¨×™ ×”×©××œ×”...');
                if (database && isConnected) {
                    loadDataFromFirebase();
                }
            }, 1000);
        }

        // Submit Multi-Cart Loan
        function submitMultiCartLoan() {
            if (selectedComputers.length !== currentLoan.computerCount) {
                showError('×× × ×‘×—×¨ ××ª ××¡×¤×¨ ×”××—×©×‘×™× ×”× ×“×¨×© ××”×¢×’×œ×•×ª ×”×©×•× ×•×ª');
                return;
            }
            
            const cleanCartSelections = {};
            Object.keys(selectedCarts).forEach(cartId => {
                if (selectedCarts[cartId].length > 0) {
                    cleanCartSelections[cartId] = [...selectedCarts[cartId]];
                }
            });
            
            const baseLoan = {
                id: Date.now(),
                ...currentLoan,
                cartSelections: cleanCartSelections,
                computers: [...selectedComputers],
                returned: false,
                createdAt: new Date().toISOString(),
                isMultiCart: true
            };

            if (currentLoan.isRecurring) {
                const recurringLoan = {
                    ...baseLoan,
                    type: 'recurring',
                    dayOfWeek: new Date(currentLoan.loanDate).getDay()
                };
                
                systemData.recurringLoans.push(recurringLoan);
                systemData.loans.push(baseLoan);
                
                document.getElementById('successTitle').textContent = '×”×©××œ×” ×§×‘×•×¢×” × ×•×¦×¨×”!';
                document.getElementById('successMessage').textContent = `×”××—×©×‘×™× ×”×•×§×¦×• ×‘×”×¦×œ×—×” ×œ××•×¨×” ××›××” ×¢×’×œ×•×ª.\nğŸ”„ ×”×©××œ×” ×ª×—×–×•×¨ ×›×œ ×©×‘×•×¢ ×‘××•×ª×• ×™×•× ×•×©×¢×”.`;
            } else {
                systemData.loans.push(baseLoan);
                
                const returnTimeMsg = currentLoan.expectedReturnTime ? 
                    `\n×”×—×–×¨×” ××ª×•×›× × ×ª: ×”×™×•× ×‘×©×¢×” ${currentLoan.expectedReturnTime}` : '';
                
                document.getElementById('successTitle').textContent = '×”×©××œ×” ××•×©×¨×”!';
                document.getElementById('successMessage').textContent = `×”××—×©×‘×™× ×”×•×§×¦×• ×‘×”×¦×œ×—×” ×œ××•×¨×” ××›××” ×¢×’×œ×•×ª.${returnTimeMsg}`;
            }
            
            saveToFirebase();
            showScreen('successScreen');
            
            // ×¨×¢× ×•×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ ××—×¨×™ ×”×©××œ×”
            setTimeout(() => {
                console.log('ğŸ”„ ××¨×¢× ×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ ××—×¨×™ ×”×©××œ×” ×¨×‘-×¢×’×œ×•×ª...');
                if (database && isConnected) {
                    loadDataFromFirebase();
                }
            }, 1000);
        }
        
        // Submit Return
        function submitReturn() {
            const returnDate = document.getElementById('returnDate').value;
            const returnTime = document.getElementById('returnTime').value;
            const returnNotes = document.getElementById('returnNotes').value;
            
            if (!selectedLoanForReturn || !returnDate || !returnTime) {
                showError('×× × ×‘×—×¨ ×”×©××œ×” ×•××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
                return;
            }
            
            const loanIndex = systemData.loans.findIndex(l => l.id === selectedLoanForReturn.id);
            if (loanIndex !== -1) {
                systemData.loans[loanIndex].returned = true;
                systemData.loans[loanIndex].returnDate = returnDate;
                systemData.loans[loanIndex].returnTime = returnTime;
                systemData.loans[loanIndex].returnNotes = returnNotes;
                systemData.loans[loanIndex].returnedAt = new Date().toISOString();
            }
            
            saveToFirebase();
            
            document.getElementById('successTitle').textContent = '×”×—×–×¨×” ××•×©×¨×”!';
            document.getElementById('successMessage').textContent = `×”××—×©×‘×™× ×©×œ ${selectedLoanForReturn.teacherName} ×”×•×—×–×¨×• ×‘×”×¦×œ×—×” ×œ××¢×¨×›×ª.`;
            showScreen('successScreen');
            
            // ×¨×¢× ×•×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ ××—×¨×™ ×”×—×–×¨×”
            setTimeout(() => {
                console.log('ğŸ”„ ××¨×¢× ×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ ××—×¨×™ ×”×—×–×¨×”...');
                if (database && isConnected) {
                    loadDataFromFirebase();
                }
            }, 1000);
            
            selectedLoanForReturn = null;
        }
        
        // Global functions for management buttons
        window.returnSpecificLoan = returnSpecificLoan;
        window.cancelFutureLoan = cancelFutureLoan;
        window.cancelRecurringLoan = cancelRecurringLoan;
        window.switchManagementTab = switchManagementTab;
        
        // Global functions for configuration management
        window.showAddTeacherForm = showAddTeacherForm;
        window.editTeacher = editTeacher;
        window.saveTeacher = saveTeacher;
        window.deleteTeacher = deleteTeacher;
        window.cancelTeacherForm = cancelTeacherForm;
        
        window.showAddTimeForm = showAddTimeForm;
        window.editTime = editTime;
        window.saveTime = saveTime;
        window.deleteTime = deleteTime;
        window.cancelTimeForm = cancelTimeForm;
        
        window.showAddCartForm = showAddCartForm;
        window.editCart = editCart;
        window.saveCart = saveCart;
        window.deleteCart = deleteCart;
        window.cancelCartForm = cancelCartForm;
        
        window.loadComputersForCart = loadComputersForCart;
        window.showAddComputerForm = showAddComputerForm;
        window.editComputer = editComputer;
        window.saveComputer = saveComputer;
        window.deleteComputer = deleteComputer;
        window.regenerateComputers = regenerateComputers;
        window.cancelComputerForm = cancelComputerForm;
        
        // Global functions for reports
        window.exportReturnNotesToExcel = exportReturnNotesToExcel;
        window.exportAllLoansToExcel = exportAllLoansToExcel;
        
        // Event Listeners
        function setupEventListeners() {
            // Main menu buttons
            document.getElementById('loanBtn').addEventListener('click', () => {
                showScreen('teacherScreen');
                currentLoan = {};
                selectedComputers = [];
                selectedCarts = {};
                isMultiCartMode = false;
                document.getElementById('isRecurringLoan').checked = false;
                updateRecurringLoanStatus();
            });
            
            document.getElementById('returnBtn').addEventListener('click', () => {
                showScreen('returnTeacherScreen');
                selectedLoanForReturn = null;
            });
            
            document.getElementById('managementBtn').addEventListener('click', showPasswordScreen);
            
            // Loan navigation buttons
            document.getElementById('backToMain1').addEventListener('click', () => showScreen('mainScreen'));
            document.getElementById('nextToDate').addEventListener('click', goToDateScreen);
            document.getElementById('backToTeacher').addEventListener('click', () => showScreen('teacherScreen'));
            document.getElementById('nextToComputer').addEventListener('click', goToComputerScreen);
            document.getElementById('backToDate').addEventListener('click', () => showScreen('dateScreen'));
            document.getElementById('submitLoan').addEventListener('click', submitLoan);
            
            // Return navigation buttons
            document.getElementById('backToMainFromReturn1').addEventListener('click', () => showScreen('mainScreen'));
            document.getElementById('nextToReturnLoanSelect').addEventListener('click', goToReturnLoanSelect);
            document.getElementById('backToReturnTeacher').addEventListener('click', () => showScreen('returnTeacherScreen'));
            document.getElementById('submitReturn').addEventListener('click', submitReturn);
            
            document.getElementById('backToMainSuccess').addEventListener('click', () => showScreen('mainScreen'));
            
            // Cart selection (single cart mode)
            document.getElementById('cartSelect').addEventListener('change', updateAvailableComputers);
            
            // Return form change events
            document.getElementById('returnDate').addEventListener('change', updateReturnSubmitButton);
            document.getElementById('returnTime').addEventListener('change', updateReturnSubmitButton);
            
            // Management screen events
            document.getElementById('backToMainFromPassword').addEventListener('click', () => showScreen('mainScreen'));
            document.getElementById('submitPassword').addEventListener('click', checkPassword);
            document.getElementById('backToMainFromManagement').addEventListener('click', () => showScreen('mainScreen'));
            document.getElementById('refreshManagement').addEventListener('click', () => {
                loadDataFromFirebase();
                updateManagementData();
            });
            
            // Password screen - Enter key support
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // Recurring loan checkbox
            document.getElementById('isRecurringLoan').addEventListener('change', updateRecurringLoanStatus);
        }
        
        // Initialize System
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”„ ×××ª×—×œ ××¢×¨×›×ª ××©×•×¤×¨×ª...');
            
            // Initialize default configuration
            systemData.config = { ...defaultConfig };
            systemData.carts = initializeCartData();
            
            // Set default dates
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const today = new Date().toISOString().split('T')[0];
            const lastWeek = new Date();
            lastWeek.setDate(lastWeek.getDate() - 7);
            const lastWeekStr = lastWeek.toISOString().split('T')[0];
            
            document.getElementById('loanDate').value = tomorrowStr;
            document.getElementById('returnDate').value = today;
            
            // ×”×’×“×¨×ª ×ª××¨×™×›×™ ×‘×¨×™×¨×ª ××—×“×œ ×œ×“×•×—×•×ª
            document.getElementById('reportDateFrom').value = lastWeekStr;
            document.getElementById('reportDateTo').value = today;
            
            // Populate initial selectors
            populateAllSelectors();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize Firebase
            initFirebase();
            
            console.log('âœ… ×”××¢×¨×›×ª ×”××©×•×¤×¨×ª ××•×›× ×” ×œ×©×™××•×© - ×›×•×œ×œ × ×™×”×•×œ ×ª×¦×•×¨×” ××œ× ×•×“×•×—×•×ª');
        });
    </script>
</body>
</html>
                    